<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì´í´ë¦½ìŠ¤ì˜ ë”œë ˜</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="logo.png">
  <link rel="icon" type="image/png" sizes="16x16" href="logo.png">
  <link rel="shortcut icon" href="logo.png">
  
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6d5dbc">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ë”œë ˜">
  <link rel="apple-touch-icon" href="icon-192.png">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <!-- SEO -->
  <meta name="description" content="ë‚˜ëŠ” ì–´ë–¤ ì„ íƒì„ í•˜ëŠ” ì‚¬ëŒì¼ê¹Œ? íŠ¸ë¡¤ë¦¬ ë”œë ˆë§ˆ, ë³µì œì¸ê°„ ë“± ì² í•™ì  ì„ íƒì„ ê²½í—˜í•´ë³´ì„¸ìš”.">
  <meta property="og:title" content="ì´í´ë¦½ìŠ¤ì˜ ë”œë ˜ - ë‹¹ì‹ ì˜ ë„ë• ì„±í–¥ì€?">
  <meta property="og:description" content="ë‚˜ëŠ” ì–´ë–¤ ì„ íƒì„ í•˜ëŠ” ì‚¬ëŒì¼ê¹Œ? íŠ¸ë¡¤ë¦¬ ë”œë ˆë§ˆ, ë³µì œì¸ê°„ ë“± ì² í•™ì  ì„ íƒì„ ê²½í—˜í•´ë³´ì„¸ìš”.">
  <meta property="og:image" content="https://eclipse-mindlab.github.io/mindlab/og-image.png?v=3">
  <meta property="og:url" content="https://eclipse-mindlab.github.io/mindlab/">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="ì´í´ë¦½ìŠ¤ì˜ ë”œë ˜ - ë‹¹ì‹ ì˜ ë„ë• ì„±í–¥ì€?">
  <meta name="twitter:description" content="ë‚˜ëŠ” ì–´ë–¤ ì„ íƒì„ í•˜ëŠ” ì‚¬ëŒì¼ê¹Œ? íŠ¸ë¡¤ë¦¬ ë”œë ˆë§ˆ, ë³µì œì¸ê°„ ë“± ì² í•™ì  ì„ íƒì„ ê²½í—˜í•´ë³´ì„¸ìš”.">
  <meta name="twitter:image" content="https://eclipse-mindlab.github.io/mindlab/og-image.png?v=3">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #09090b;
      color: #fff;
      min-height: 100vh;
      line-height: 1.6;
    }
    
    .container { max-width: 480px; margin: 0 auto; padding: 24px 16px; }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .brand { display: flex; align-items: center; gap: 10px; }
    .brand-logo { width: 36px; height: 36px; border-radius: 50%; }
    .brand-text { font-size: 18px; font-weight: 600; color: #9580ff; }
    
    .beta-badge {
      font-size: 10px;
      padding: 2px 6px;
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
      border-radius: 4px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .header-links { display: flex; gap: 12px; }
    .header-link { color: #8b8b92; text-decoration: none; font-size: 13px; }
    .header-link:hover { color: #9580ff; }

    .profile-card {
      background: linear-gradient(135deg, #141417 0%, #1a1a1e 100%);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid #232326;
      position: relative;
    }

    .google-sync-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #232326;
      border: 1px solid #35353a;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .google-sync-btn:hover {
      background: #35353a;
      transform: scale(1.05);
    }

    .google-sync-btn.synced {
      background: #2d5a41;
      border-color: #5cb88a;
    }

    .google-sync-btn.synced svg {
      display: none;
    }

    .google-sync-btn.synced::after {
      content: 'âœ“';
      color: #fff;
      font-size: 16px;
    }

    .profile-top { display: flex; gap: 16px; margin-bottom: 16px; }

    .tier-badge { 
      width: 72px; 
      flex-shrink: 0; 
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }
    .tier-badge img { width: 72px; height: 72px; border-radius: 50%; object-fit: cover; }
    .tier-label {
      font-size: 12px;
      font-weight: 600;
      padding: 2px 10px;
      border-radius: 10px;
      background: rgba(239, 68, 68, 0.2);
      color: #dc6b6b;
    }

    .profile-info { flex: 1; }
    .profile-name-row { display: flex; align-items: center; gap: 8px; margin-bottom: 2px; }
    .profile-name { font-size: 20px; font-weight: 600; }
    .edit-name-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #232326;
      border: 1px solid #35353a;
      color: #8b8b92;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .edit-name-btn:hover {
      background: #35353a;
      color: #9580ff;
    }
    .profile-title { font-size: 13px; color: #9580ff; margin-bottom: 8px; }

    .level-info { display: flex; align-items: center; gap: 8px; }
    .level-text { font-size: 12px; color: #8b8b92; }
    .level-num { color: #fff; font-weight: 600; }
    .exp-bar { flex: 1; height: 6px; background: #232326; border-radius: 3px; overflow: hidden; }
    .exp-fill { height: 100%; background: linear-gradient(90deg, #9580ff, #9580ff); border-radius: 3px; }
    .exp-text { font-size: 11px; color: #8b8b92; }

    .journey-section { margin-top: 16px; padding-top: 16px; border-top: 1px solid #232326; }
    .journey-title { font-size: 13px; color: #8b8b92; margin-bottom: 12px; }
    .journey-stats { display: flex; gap: 16px; }
    .journey-stat { flex: 1; text-align: center; padding: 12px; background: #1a1a1e; border-radius: 10px; }
    .journey-stat-value { font-size: 20px; font-weight: 700; }
    .journey-stat-label { font-size: 11px; color: #8b8b92; }

    .save-profile-btn {
      width: 100%;
      margin-top: 16px;
      padding: 14px;
      background: linear-gradient(135deg, #6d5dbc, #9580ff);
      border: none;
      border-radius: 12px;
      color: #fff;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .save-profile-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4);
    }

    .save-profile-btn.success {
      background: #2d5a41;
    }

    .install-btn {
      width: 100%;
      margin-top: 16px;
      padding: 14px;
      background: linear-gradient(135deg, #6d5dbc, #5b21b6);
      border: none;
      border-radius: 12px;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .install-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4);
    }

    .install-btn.hidden { display: none; }

    .share-app-btn {
      width: 100%;
      margin-top: 10px;
      padding: 14px;
      background: #232326;
      border: 1px solid #35353a;
      border-radius: 12px;
      color: #fff;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .share-app-btn:hover {
      background: #35353a;
    }

    .share-app-btn.success {
      background: #2d5a41;
      border-color: #5cb88a;
    }

    .backup-warning {
      margin-top: 12px;
      padding: 12px 14px;
      background: rgba(234, 179, 8, 0.1);
      border: 1px solid rgba(234, 179, 8, 0.3);
      border-radius: 10px;
      display: flex;
      align-items: flex-start;
      gap: 8px;
      font-size: 12px;
      color: #eab308;
      line-height: 1.4;
    }

    .backup-warning .warning-icon {
      flex-shrink: 0;
    }

    .daily-banner {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(149, 128, 255, 0.12), rgba(109, 93, 188, 0.08));
      border: 1px solid rgba(149, 128, 255, 0.25);
      border-radius: 14px;
      margin-bottom: 24px;
      text-decoration: none;
      color: #fff;
      transition: transform 0.15s ease, border-color 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }

    .daily-banner:hover {
      border-color: #9580ff;
    }

    .daily-banner:active {
      transform: scale(0.98);
      border-color: #9580ff;
    }

    .daily-icon { font-size: 28px; }
    .daily-content { flex: 1; }
    .daily-title { font-size: 16px; font-weight: 600; margin-bottom: 2px; }
    .daily-desc { font-size: 12px; color: #9580ff; }
    .daily-arrow { font-size: 18px; color: #8b8b92; }

    .my-challenges-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px 16px;
      background: #141417;
      border: 1px solid #232326;
      border-radius: 12px;
      margin-bottom: 24px;
      text-decoration: none;
      color: #fff;
      transition: transform 0.15s ease, background 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }

    .my-challenges-btn:hover {
      background: #1a1a1e;
    }

    .my-challenges-btn:active {
      transform: scale(0.98);
      background: #1f1f23;
    }

    .my-challenges-btn.hidden {
      display: none;
    }

    .my-challenges-icon {
      font-size: 20px;
    }

    .my-challenges-text {
      flex: 1;
      font-size: 14px;
      font-weight: 500;
    }

    .my-challenges-count {
      background: #9580ff;
      color: #000;
      font-size: 12px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 10px;
    }

    .map-section { margin-bottom: 24px; }
    .section-header { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; margin-bottom: 12px; gap: 4px; }
    .section-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
    .section-title .icon { font-size: 20px; }
    .section-subtitle { width: 100%; font-size: 12px; color: #8b8b92; margin-left: 28px; }
    .section-progress { font-size: 13px; color: #8b8b92; }

    .category-card {
      background: #141417;
      border: 1px solid #232326;
      border-radius: 16px;
      padding: 12px;
    }

    .sim-list { display: flex; flex-direction: column; gap: 8px; }

    .sim-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: #1a1a1e;
      border-radius: 10px;
      text-decoration: none;
      color: #fff;
      transition: transform 0.15s ease, background 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }

    .sim-item:hover { background: #232326; }
    .sim-item:active { transform: scale(0.98); background: #252528; }
    .sim-item.locked { opacity: 0.5; pointer-events: none; }
    .sim-item.completed { border-left: 3px solid #5cb88a; }

    .sim-status { width: 24px; text-align: center; font-size: 14px; }
    .sim-info { flex: 1; }
    .sim-title { font-size: 14px; font-weight: 500; }
    .sim-desc { font-size: 12px; color: #8b8b92; }
    .sim-reward { font-size: 11px; color: #9580ff; }

    /* ì›ì¹™ ë„ê° ë§í¬ */
    .dex-link {
      display: block;
      background: linear-gradient(135deg, #141417 0%, #1a1a1e 100%);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
      border: 1px solid #232326;
      text-decoration: none;
      color: #fff;
      transition: transform 0.15s ease, border-color 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }

    .dex-link:hover {
      border-color: #6d5dbc;
    }

    .dex-link:active {
      transform: scale(0.98);
      border-color: #6d5dbc;
    }

    .dex-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .dex-title {
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .dex-count {
      font-size: 14px;
      color: #9580ff;
      font-weight: 600;
    }

    .dex-progress {
      height: 8px;
      background: #232326;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .dex-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #6d5dbc, #9580ff);
      border-radius: 4px;
      transition: width 0.3s;
    }

    .dex-subtitle {
      font-size: 12px;
      color: #8b8b92;
    }

    .tier-section { background: #141417; border-radius: 16px; padding: 20px; margin-bottom: 24px; }
    .tier-progress { display: flex; justify-content: space-between; align-items: center; margin-top: 16px; }
    .tier-item { display: flex; flex-direction: column; align-items: center; gap: 6px; }
    .tier-icon { width: 32px; height: 32px; border-radius: 50%; overflow: hidden; opacity: 0.3; }
    .tier-icon.active { opacity: 1; box-shadow: 0 0 12px rgba(167, 139, 250, 0.5); }
    .tier-icon.completed { opacity: 0.7; }
    .tier-icon img { width: 100%; height: 100%; object-fit: cover; }
    .tier-name { font-size: 10px; color: #52525b; }
    .tier-item.active .tier-name { color: #9580ff; font-weight: 600; }

    .book-section { margin-bottom: 24px; }
    
    /* ì´í´ë¦½ìŠ¤ ë” ì•Œì•„ë³´ê¸° ì„¹ì…˜ */
    .eclipse-section {
      text-align: center;
      padding: 24px 0;
      border-top: 1px solid #232326;
      margin-bottom: 24px;
    }
    
    .eclipse-section-title {
      font-size: 14px;
      color: #8b8b92;
      margin-bottom: 16px;
    }
    
    .youtube-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 14px 32px;
      background: #232326;
      border: 1px solid #35353a;
      border-radius: 12px;
      color: #fff;
      font-size: 15px;
      font-weight: 500;
      text-decoration: none;
      transition: all 0.2s;
    }
    
    .youtube-btn:hover {
      background: #35353a;
      transform: translateY(-2px);
    }
    
    .youtube-btn svg {
      fill: #dc6b6b;
    }
    
    /* ì±… ì„¹ì…˜ */
    .books-section {
      text-align: center;
      padding-top: 24px;
      border-top: 1px solid #232326;
      margin-bottom: 24px;
    }
    
    .books-section-title {
      font-size: 14px;
      color: #8b8b92;
      margin-bottom: 20px;
    }
    
    .books-grid {
      display: flex;
      gap: 16px;
      justify-content: center;
    }
    
    .book-item {
      flex: 1;
      max-width: 160px;
      text-decoration: none;
      color: #fff;
      transition: all 0.2s;
    }
    
    .book-item:hover {
      transform: translateY(-4px);
    }
    
    .book-item img {
      width: 100%;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      margin-bottom: 10px;
    }
    
    .book-item-title {
      font-size: 13px;
      color: #a1a1aa;
    }
    
    .book-card {
      display: flex;
      align-items: center;
      gap: 16px;
      background: linear-gradient(135deg, #1a1520 0%, #141417 100%);
      border: 1px solid #2d2438;
      border-radius: 16px;
      padding: 16px;
      text-decoration: none;
      color: #fff;
      transition: all 0.2s;
    }
    
    .book-card:hover {
      border-color: #9580ff;
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(167, 139, 250, 0.15);
    }
    
    .book-images {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }
    
    .book-img {
      width: 56px;
      height: auto;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.4);
    }
    
    .book-info { flex: 1; }
    .book-series { font-size: 11px; color: #9580ff; margin-bottom: 4px; }
    .book-main-title { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
    .book-desc { font-size: 12px; color: #8b8b92; }

    .footer { text-align: center; padding: 24px 0; border-top: 1px solid #232326; }
    .footer-links { display: flex; justify-content: center; gap: 24px; margin-bottom: 16px; }
    .footer-link { display: flex; align-items: center; gap: 6px; color: #8b8b92; text-decoration: none; font-size: 13px; }
    .footer-link:hover { color: #9580ff; }
    .footer-copy { font-size: 11px; color: #52525b; }

    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex; align-items: center; justify-content: center;
      z-index: 100; padding: 20px;
    }
    .modal-overlay.hidden { display: none; }
    .modal {
      background: #141417; border-radius: 20px;
      padding: 32px 24px; max-width: 360px; width: 100%; text-align: center;
    }
    .modal-logo { width: 64px; height: 64px; border-radius: 50%; margin-bottom: 16px; }
    .modal-title { font-size: 20px; font-weight: 600; margin-bottom: 8px; }
    .modal-desc { font-size: 14px; color: #8b8b92; margin-bottom: 24px; line-height: 1.6; }
    .modal-input {
      width: 100%; padding: 14px 16px;
      background: #232326; border: 1px solid #35353a; border-radius: 12px;
      color: #fff; font-size: 16px; margin-bottom: 16px; text-align: center;
    }
    .modal-input:focus { outline: none; border-color: #6d5dbc; }
    .modal-btn {
      width: 100%; padding: 14px;
      background: #6d5dbc; border: none; border-radius: 12px;
      color: #fff; font-size: 16px; font-weight: 600; cursor: pointer;
    }
    .modal-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .modal-btn.cancel {
      background: #232326;
      color: #a1a1aa;
    }
    .modal-buttons {
      display: flex;
      gap: 12px;
    }
    .modal-buttons .modal-btn {
      flex: 1;
    }
  </style>
</head>
<body>
  <div class="modal-overlay" id="nameModal">
    <div class="modal">
      <img src="logo.png" alt="ì´í´ë¦½ìŠ¤" class="modal-logo">
      <div class="modal-title">ì´í´ë¦½ìŠ¤ì˜ ë”œë ˜</div>
      <div class="modal-desc">ì§€ì  íƒí—˜ì„ ì‹œì‘í•˜ì„¸ìš”.<br>ì‹¬ë¦¬, ì² í•™, ì‚¬íšŒì˜ ìˆ¨ê²¨ì§„ ì›ì¹™ë“¤ì„ ë°œê²¬í•©ë‹ˆë‹¤.</div>
      <input type="text" class="modal-input" id="nameInput" placeholder="íƒí—˜ê°€ ì´ë¦„" maxlength="12">
      <button class="modal-btn" id="startBtn" disabled>íƒí—˜ ì‹œì‘</button>
    </div>
  </div>

  <div class="modal-overlay hidden" id="editNameModal">
    <div class="modal">
      <div class="modal-title">ë‹‰ë„¤ì„ ë³€ê²½</div>
      <div class="modal-desc">ìƒˆë¡œìš´ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.</div>
      <input type="text" class="modal-input" id="editNameInput" placeholder="ìƒˆ ë‹‰ë„¤ì„" maxlength="12">
      <div class="modal-buttons">
        <button class="modal-btn cancel" id="editNameCancelBtn">ì·¨ì†Œ</button>
        <button class="modal-btn" id="editNameSaveBtn" disabled>ì €ì¥</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="header">
      <div class="brand">
        <img src="logo.png" alt="ì´í´ë¦½ìŠ¤" class="brand-logo">
        <span class="brand-text">ì´í´ë¦½ìŠ¤ì˜ ë”œë ˜</span>
        <span class="beta-badge">BETA</span>
      </div>
      <div class="header-links">
        <a href="https://www.youtube.com/@Eclipse-g4e" target="_blank" class="header-link">ìœ íŠœë¸Œ</a>
        <a href="https://litt.ly/eclipse.thinker" target="_blank" class="header-link">ì±…</a>
      </div>
    </div>

    <div class="profile-card">
      <button class="google-sync-btn" id="googleSyncBtn" title="êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ë°±ì—…">
        <svg width="18" height="18" viewBox="0 0 24 24">
          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
      </button>
      <div class="profile-top">
        <div class="tier-badge">
          <img src="tier-ruby.png" alt="í‹°ì–´" id="tierImage">
          <span class="tier-label" id="tierLabel">ë£¨ë¹„</span>
        </div>
        <div class="profile-info">
          <div class="profile-name-row">
            <div class="profile-name" id="profileName">íƒí—˜ê°€</div>
            <button class="edit-name-btn" id="editNameBtn" title="ë‹‰ë„¤ì„ ë³€ê²½">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
              </svg>
            </button>
          </div>
          <div class="profile-title" id="profileTitle">ğŸŒ± ì´ˆë³´ íƒí—˜ê°€</div>
          <div class="level-info">
            <span class="level-text">Lv.<span class="level-num" id="levelNum">1</span></span>
            <div class="exp-bar">
              <div class="exp-fill" id="expFill" style="width: 0%"></div>
            </div>
            <span class="exp-text" id="expText">0/100</span>
          </div>
        </div>
      </div>
      <div class="journey-section">
        <div class="journey-title">íƒí—˜ í˜„í™©</div>
        <div class="journey-stats">
          <div class="journey-stat">
            <div class="journey-stat-value" id="statCleared">0</div>
            <div class="journey-stat-label">í´ë¦¬ì–´</div>
          </div>
          <div class="journey-stat">
            <div class="journey-stat-value" id="statPrinciples">0</div>
            <div class="journey-stat-label">ë°œê²¬í•œ ì›ì¹™</div>
          </div>
          <div class="journey-stat">
            <div class="journey-stat-value" id="statMaxStreak">0</div>
            <div class="journey-stat-label">ìµœëŒ€ ì—°ì†</div>
          </div>
        </div>
      </div>

      <button class="save-profile-btn" id="saveProfileBtn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
          <circle cx="8.5" cy="8.5" r="1.5"/>
          <polyline points="21 15 16 10 5 21"/>
        </svg>
        í”„ë¡œí•„ ì´ë¯¸ì§€ ì €ì¥
      </button>

      <button class="install-btn hidden" id="installBtn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ê¸°
      </button>

      <button class="share-app-btn" id="shareAppBtn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/>
          <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
          <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
        </svg>
        ì¹œêµ¬ì—ê²Œ ê³µìœ í•˜ê¸°
      </button>
      
      <div class="backup-warning" id="backupWarning">
        <span class="warning-icon">âš ï¸</span>
        <span class="warning-text">êµ¬ê¸€ ê³„ì • ì—°ë™ ì „ê¹Œì§€ ë¸Œë¼ìš°ì € ë°ì´í„° ì‚­ì œ ì‹œ ì§„í–‰ìƒí™©ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤</span>
      </div>
    </div>

    <a href="daily.html" class="daily-banner">
      <div class="daily-icon">ğŸ¤”</div>
      <div class="daily-content">
        <div class="daily-title">ì˜¤ëŠ˜ì˜ ë”œë ˆë§ˆ</div>
        <div class="daily-desc">ë§¤ì¼ ìƒˆë¡œìš´ ì§ˆë¬¸ì— ë‹µí•˜ê³  +10 EXP</div>
      </div>
      <div class="daily-arrow">â†’</div>
    </a>

    <a href="read-me.html" class="daily-banner" style="background: linear-gradient(135deg, rgba(244, 114, 182, 0.15), rgba(167, 139, 250, 0.1)); border-color: rgba(244, 114, 182, 0.3);">
      <div class="daily-icon">ğŸ”®</div>
      <div class="daily-content">
        <div class="daily-title">ë‚˜ë¥¼ ì½ì–´ë´</div>
        <div class="daily-desc" style="color: #f472b6;">ì¹œêµ¬ì—ê²Œ ë„ì „ì¥ ë³´ë‚´ê¸°</div>
      </div>
      <div class="daily-arrow">â†’</div>
    </a>

    <a href="my-challenges.html" class="my-challenges-btn hidden" id="myChallengesBtn">
      <span class="my-challenges-icon">ğŸ“Š</span>
      <span class="my-challenges-text">ë‚´ ë„ì „ì¥ í˜„í™©</span>
      <span class="my-challenges-count" id="myChallengesCount">0</span>
    </a>

    <div class="map-section">
      <div class="section-header">
        <div class="section-title"><span class="icon">ğŸ“–</span> ë§ˆì¸ë“œ ìŠ¤í† ë¦¬</div>
        <div class="section-subtitle">ë‹¹ì‹ ì´ ì£¼ì¸ê³µì¸ ì†Œì„¤</div>
        <div class="section-progress" id="storyProgress">0/1</div>
      </div>
      <div class="category-card">
        <div class="sim-list" id="storyList"></div>
      </div>
    </div>

    <div class="map-section">
      <div class="section-header">
        <div class="section-title"><span class="icon">ğŸ’­</span> ì² í•™ ì‹œë®¬ë ˆì´í„°</div>
        <div class="section-progress" id="philProgress">0/2</div>
      </div>
      <div class="category-card">
        <div class="sim-list" id="philList"></div>
      </div>
    </div>

    <div class="map-section">
      <div class="section-header">
        <div class="section-title"><span class="icon">ğŸ§ </span> ì‹¬ë¦¬ ì‹œë®¬ë ˆì´í„°</div>
        <div class="section-progress" id="psychProgress">0/2</div>
      </div>
      <div class="category-card">
        <div class="sim-list" id="psychList"></div>
      </div>
    </div>

    <div class="map-section">
      <div class="section-header">
        <div class="section-title"><span class="icon">ğŸ¯</span> ì „ëµ ì‹œë®¬ë ˆì´í„°</div>
        <div class="section-progress" id="strategyProgress">0/1</div>
      </div>
      <div class="category-card">
        <div class="sim-list" id="strategyList"></div>
      </div>
    </div>

    <a href="dex.html" class="dex-link">
      <div class="dex-header">
        <div class="dex-title"><span class="icon">ğŸ’</span> ì›ì¹™ ë„ê°</div>
        <div class="dex-count" id="dexCount">0/80</div>
      </div>
      <div class="dex-progress">
        <div class="dex-progress-fill" id="dexProgressFill" style="width: 0%"></div>
      </div>
      <div class="dex-subtitle">ì‹œë®¬ë ˆì´í„°ë¥¼ í´ë¦¬ì–´í•˜ë©° ì›ì¹™ì„ ìˆ˜ì§‘í•˜ì„¸ìš” â†’</div>
    </a>

    <div class="tier-section">
      <div class="section-title">í‹°ì–´ ì§„í–‰ë„</div>
      <div class="tier-progress">
        <div class="tier-item active" data-tier="ruby">
          <div class="tier-icon active"><img src="tier-ruby.png"></div>
          <span class="tier-name">ë£¨ë¹„</span>
        </div>
        <div class="tier-item" data-tier="amethyst">
          <div class="tier-icon"><img src="tier-amethyst.png"></div>
          <span class="tier-name">ììˆ˜ì •</span>
        </div>
        <div class="tier-item" data-tier="sapphire">
          <div class="tier-icon"><img src="tier-sapphire.png"></div>
          <span class="tier-name">ì‚¬íŒŒì´ì–´</span>
        </div>
        <div class="tier-item" data-tier="emerald">
          <div class="tier-icon"><img src="tier-emerald.png"></div>
          <span class="tier-name">ì—ë©”ë„ë“œ</span>
        </div>
        <div class="tier-item" data-tier="obsidian">
          <div class="tier-icon"><img src="tier-obsidian.png"></div>
          <span class="tier-name">ì˜µì‹œë””ì–¸</span>
        </div>
        <div class="tier-item" data-tier="gold">
          <div class="tier-icon"><img src="tier-gold.png"></div>
          <span class="tier-name">ê³¨ë“œ</span>
        </div>
      </div>
    </div>

    <div class="eclipse-section">
      <div class="eclipse-section-title">ì´í´ë¦½ìŠ¤ ë” ì•Œì•„ë³´ê¸°</div>
      <a href="https://www.youtube.com/@Eclipse-g4e" target="_blank" class="youtube-btn">
        <svg width="24" height="24" viewBox="0 0 24 24">
          <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814z"/>
          <path fill="#fff" d="M9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
        </svg>
        ìœ íŠœë¸Œ ì±„ë„
      </a>
    </div>

    <div class="books-section">
      <div class="books-section-title">ì´í´ë¦½ìŠ¤ì˜ ì±…</div>
      <div class="books-grid">
        <a href="https://litt.ly/eclipse.thinker" target="_blank" class="book-item">
          <img src="book-philosophy.png" alt="í›”ì¹œ ì² í•™ í¸">
          <div class="book-item-title">í›”ì¹œ ì² í•™ í¸</div>
        </a>
        <a href="https://litt.ly/eclipse.thinker" target="_blank" class="book-item">
          <img src="book-psychology.png" alt="í›”ì¹œ ì‹¬ë¦¬í•™ í¸">
          <div class="book-item-title">í›”ì¹œ ì‹¬ë¦¬í•™ í¸</div>
        </a>
      </div>
    </div>

    <div class="footer">
      <div class="footer-copy">Â© ë”œë ˜</div>
    </div>
  </div>

  <script type="module">
    // Firebase SDK
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, linkWithPopup, signInWithRedirect, getRedirectResult, signInWithCredential } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyDZ-NATGNFjQ90gswfebIV-0xqhps68qJM",
      authDomain: "eclipse-mindlab.firebaseapp.com",
      projectId: "eclipse-mindlab",
      storageBucket: "eclipse-mindlab.firebasestorage.app",
      messagingSenderId: "181450990304",
      appId: "1:181450990304:web:3043d3857815249f53e685",
      measurementId: "G-2V3Z9XZJYT"
    };

    // Firebase ì´ˆê¸°í™”
    const firebaseApp = initializeApp(firebaseConfig);
    const auth = getAuth(firebaseApp);
    const db = getFirestore(firebaseApp);

    const STORAGE_KEY = 'eclipse_mindlab_profile';
    const CURRENT_VERSION = 5;

    const TIERS = [
      { name: 'ë£¨ë¹„', key: 'ruby', minLevel: 1, color: '#dc6b6b', colorName: 'ë¹¨ê°„ìƒ‰' },
      { name: 'ììˆ˜ì •', key: 'amethyst', minLevel: 6, color: '#a855f7', colorName: 'ë³´ë¼ìƒ‰' },
      { name: 'ì‚¬íŒŒì´ì–´', key: 'sapphire', minLevel: 11, color: '#3b82f6', colorName: 'íŒŒë€ìƒ‰' },
      { name: 'ì—ë©”ë„ë“œ', key: 'emerald', minLevel: 16, color: '#10b981', colorName: 'ì´ˆë¡ìƒ‰' },
      { name: 'ì˜µì‹œë””ì–¸', key: 'obsidian', minLevel: 21, color: '#1f2937', colorName: 'ê²€ì€ìƒ‰' },
      { name: 'ê³¨ë“œ', key: 'gold', minLevel: 26, color: '#f59e0b', colorName: 'ê¸ˆìƒ‰' }
    ];

    const TITLES = [
      { minLevel: 1, title: 'ğŸŒ± ì´ˆë³´ íƒí—˜ê°€' },
      { minLevel: 5, title: 'ğŸŒ¿ í˜¸ê¸°ì‹¬ ë§ì€ ê´€ì°°ì' },
      { minLevel: 10, title: 'ğŸŒ³ ê¹Šì´ ìˆëŠ” ì‚¬ìƒ‰ê°€' },
      { minLevel: 20, title: 'ğŸŒŸ í†µì°°ì˜ ëŒ€ê°€' }
    ];

    const SIMULATIONS = {
      story: [
        { id: 'clone', title: 'ë³µì œì¸ê°„', desc: 'ì™„ë²½í•œ ë³µì œë³¸ì´ ë‚˜íƒ€ë‚¬ë‹¤. ëˆ„ê°€ ì§„ì§œì¸ê°€?', url: 'sim-clone.html' }
      ],
      philosophy: [
        { id: 'god', title: 'ì‹ ì´ ëœë‹¤ë©´', desc: '24ì‹œê°„ ë™ì•ˆ ì „ì§€ì „ëŠ¥í•´ì§„ë‹¤. ë¬´ì—‡ì„ í•˜ê² ëŠ”ê°€?', url: 'sim-god.html', locked: true, unlockDate: '2026-02-05T09:00:00+09:00' },
        { id: 'immortality', title: 'ì˜ìƒ', desc: 'ì˜ì›íˆ ì‚´ ìˆ˜ ìˆë‹¤. ì¶•ë³µì¸ê°€, ì €ì£¼ì¸ê°€?', url: 'sim-immortality.html', locked: true, unlockDate: '2026-02-06T09:00:00+09:00' },
        { id: 'awakening', title: 'ê¹¨ì–´ë‚¨', desc: 'ì´ ì„¸ê³„ê°€ ì‹œë®¬ë ˆì´ì…˜ì´ë¼ë©´, ë‹¹ì‹ ì€ ê¹¨ì–´ë‚  ê²ƒì¸ê°€?', url: 'sim-awakening.html' },
        { id: 'last-human', title: 'ë§ˆì§€ë§‰ ì¸ë¥˜', desc: 'ì§€êµ¬ì— ë‚¨ì€ ë§ˆì§€ë§‰ ì‚¬ëŒ. ì™œ ì‚´ì•„ì•¼ í•˜ëŠ”ê°€?', url: 'sim-last-human.html' },
        { id: 'death', title: 'ì£½ìŒì„ ì•ë‘” ì„ íƒ', desc: '6ê°œì›”ì´ ë‚¨ì•˜ë‹¤. ë‹¹ì‹ ì€ ì–´ë–»ê²Œ ì‚´ê² ëŠ”ê°€?', url: 'sim-death.html' },
        { id: 'trolley', title: 'íŠ¸ë¡¤ë¦¬ ë”œë ˆë§ˆ', desc: 'ë‹¹ì‹ ì˜ ë„ë•ì  ê¸°ì¤€ì€ ì–´ë””ê¹Œì§€ í”ë“¤ë¦´ê¹Œ?', url: 'sim-trolley.html' },
        { id: 'experience_machine', title: 'ê²½í—˜ ê¸°ê³„', desc: 'ì™„ë²½í•œ ê°€ì§œ í–‰ë³µ vs ë¶ˆì™„ì „í•œ í˜„ì‹¤', url: 'sim-experience-machine.html' }
      ],
      psych: [
        { id: 'breakup', title: 'ì´ë³„ ì‹œë®¬ë ˆì´í„°', desc: 'ì‚¬ë‘ì´ ëë‚  ë•Œ, ë‹¹ì‹ ì€ ì–´ë–¤ ì„ íƒì„ í•˜ëŠ”ê°€?', url: 'sim-breakup.html', locked: true, unlockDate: '2026-02-04T09:00:00+09:00' },
        { id: 'shadow', title: 'ë‚´ë©´ì˜ ê·¸ë¦¼ì', desc: 'ë‹¹ì‹ ì´ ìˆ¨ê¸°ê³  ìˆëŠ” ë˜ ë‹¤ë¥¸ ìì•„ëŠ”?', url: 'sim-shadow.html', locked: true, unlockDate: '2026-02-07T09:00:00+09:00' },
        { id: 'replacement', title: 'ì™„ë²½í•œ ëŒ€ì²´ì', desc: 'ë‚˜ë³´ë‹¤ ëª¨ë“  ë©´ì—ì„œ ë‚˜ì€ ì‚¬ëŒì´ ë‚˜íƒ€ë‚¬ë‹¤', url: 'sim-replacement.html' },
        { id: 'left-on-read', title: 'ì½ì”¹ ì‹œë®¬ë ˆì´í„°', desc: 'ì½ìŒ. ê·¸ë¦¬ê³  ì¹¨ë¬µ. ë‹¹ì‹ ì€ ì–´ë–»ê²Œ ë°˜ì‘í•˜ë‚˜ìš”?', url: 'sim-left-on-read.html' },
        { id: 'revenge', title: 'ë³µìˆ˜ ì‹œë®¬ë ˆì´í„°', desc: 'ë³µìˆ˜í•  ê¸°íšŒê°€ ì™”ë‹¤. ë‹¹ì‹ ì€ ì–´ë–»ê²Œ í•  ê²ƒì¸ê°€?', url: 'sim-revenge.html' },
        { id: 'gossip', title: 'ë’·ë‹´í™” í˜„ì¥', desc: 'ë™ë£Œë“¤ì´ ë‚´ ë’·ë‹´í™”ë¥¼ í•˜ê³  ìˆë‹¤', url: 'sim-gossip.html' },
        { id: 'idea_thief', title: 'ì•„ì´ë””ì–´ ë„ë‘‘ ë™ë£Œ', desc: 'ë„¤ ì•„ì´ë””ì–´ë¥¼ ê°€ë¡œì±ˆ ë™ë£Œ', url: 'sim-idea-thief.html' },
        { id: 'money_friend', title: 'ëˆ ì•ˆ ê°šëŠ” ì¹œêµ¬', desc: '3ê°œì›”ì§¸ 30ë§Œì›ì„ ì•ˆ ê°šëŠ” ì¹œêµ¬', url: 'sim-money-friend.html' },
        { id: 'survival_test', title: 'ìƒì¡´ìì˜ ì„ íƒ', desc: 'ë¬´ì¸ë„ì—ì„œ ë‹¹ì‹ ì€ ì–´ë–¤ ì„ íƒì„ í•˜ëŠ”ê°€?', url: 'sim-survival-test.html' },
        { id: 'truth', title: 'ê±°ì§“ë§ ì—†ëŠ” í•˜ë£¨', desc: '24ì‹œê°„ ë™ì•ˆ ì§„ì‹¤ë§Œ ë§í•´ì•¼ í•œë‹¤', url: 'sim-truth.html' },
        { id: 'gaslighting', title: 'ê°€ìŠ¤ë¼ì´íŒ…', desc: 'ì—°ì¸ì´ ë§í•œë‹¤. "ë„¤ê°€ ì˜ˆë¯¼í•œ ê±°ì•¼."', url: 'sim-gaslighting.html' }
      ],
      strategy: [
        { id: 'brinkmanship', title: 'ë²¼ë‘ ë í˜‘ìƒ', desc: 'ì•ˆ ì˜¬ë ¤ì£¼ë©´ ë‚˜ê°‘ë‹ˆë‹¤. ë¸”ëŸ¬í•‘ì¸ê°€, ì§„ì‹¬ì¸ê°€?', url: 'sim-brinkmanship.html' }
      ]
    };

    // ë„ê° ì´ ì›ì¹™ ìˆ˜ (dex.htmlê³¼ ë™ê¸°í™” í•„ìš”)
    const DEX_TOTAL = 365;

    let profile = {
      version: CURRENT_VERSION,
      name: '',
      level: 1,
      exp: 0,
      completedSims: [],
      principles: []
    };

    // ìœ íš¨í•œ ì›ì¹™ ëª©ë¡ (dex.html ALL_PRINCIPLESì™€ ë™ê¸°í™”)
    const VALID_PRINCIPLES = ['ì§ì ‘ ëŒ€ë©´','ì§ˆë¬¸í˜• ì••ë°•','ê´€ë§','ì‚¬ì‹¤ ê³ ì •','ì „ëµì  ê´€ìš©','ì² íšŒ','ê´€ìš© + ë°©í–¥ ì œì‹œ','ê²½ê³„ ì„¤ì •','ê²½ê³ ','ê³µê°œì  ê°œì…','ì‚¬ì „ í—ˆë½','í¬ê¸°','ì„  ê¸‹ê³  ë¦¬ì…‹','ê±°ë¦¬ ìœ ì§€','ì£¼ë„ê¶Œ í™•ë³´','ê³¼ì‰ ì–‘ë³´','ì‹ ë¢° íšŒë³µ í™•ì¸','ê³µìœ  í¬ë ˆë”§','ê²½ê³„ í›„ í˜‘ë ¥','ê°’ë¹„ì‹¼ êµí›ˆ','ê¸´ì¥ ì™„í™”','ëƒ‰ì „ ìœ ì§€','ëŠ¦ì€ ê²½ê³„','ë’¤ëŠ¦ì€ ê³ ë°œ','ë¯¸ë˜ ì§€í–¥','ì‚¼í‚¨ ë¶„ë…¸','ì‹¤ìš©ì  í™”í•´','ì—…ë¬´ ë¶„ë¦¬','íŒ¨í„´ ê³ ì°©','ê³µê°œì  ì••ë°•ì˜ ì—­íš¨ê³¼','ê°œì¸ì  ì ‘ê·¼','ì†Œê·¹ì  ê¸°ëŒ€ì˜ í•¨ì •','ê°ì • ëŒ€ ê°ì •ì˜ ì•…ìˆœí™˜','ê°ì • ì¸ì • í›„ ë³¸ë¡ ','ê³¼ë„í•œ ì–‘ë³´','ë°˜ë³µë˜ëŠ” ì•½ì†ì˜ í‰ê°€ì ˆí•˜','ì‘ì€ ë‹¨ìœ„ë¡œ ìª¼ê°œê¸°','ì—´ë¦° ì§ˆë¬¸ê³¼ ê²½ì²­','ëŒ€ë©´ì˜ í˜','ìê¸° ìƒí™© ê³µê°œ','ê°„ì ‘ ì†Œí†µì˜ ë¦¬ìŠ¤í¬','ë§¤ëª°ë¹„ìš©ì˜ ì†ì ˆ','ê°ì •ê³¼ ë¬¸ì œì˜ ë¶„ë¦¬','êµ¬ì²´ì  ì•½ì†','í•™ìŠµëœ ë¬´ë ¥ê°','ì§€ì†ì  ìš”ì²­','ìˆ˜ì—…ë£Œ','ë§ˆê°ì˜ í˜','ì§ì ‘ì  ì§ˆë¬¸','êµ¬ì²´ì  ì‹¤í–‰ ê³„íš','ë¶ˆì™„ì „í•œ ë§ˆë¬´ë¦¬','ìƒí˜¸ ì´í•´ì˜ í˜','ì„±ê³µ ê²½í—˜ì˜ ê°•í™”','ì†”ì§í•œ ì¸ì •','ì‹ ë¢°ì˜ íšŒë³µ','ìê¸° ì£¼ì¥','ìë°œì  ë™ê¸°','ì •ë‹¹í™”ì˜ í•¨ì •','ì¡°ê±´ë¶€ ê´€ìš©','ì¾Œë½ì£¼ì˜','ì§„ì •ì„±','ì² í•™ì  ë³´ë¥˜','ê¸‰ì§„ì  ì£¼ê´€ì£¼ì˜','ê°€ì¹˜ì˜ ìœ„ê³„','ì‹¤ì¬ë¡ ','íšŒì˜ì£¼ì˜','ì‹¤ìš©ì£¼ì˜','ì°½ì¡°ì  ë‹ˆíë¦¬ì¦˜','ììœ ì˜ì§€ ì¡´ì¤‘','ìê¸° ì •ì§ì˜ ì˜ë¬´','ì˜ë¯¸ ì¶”êµ¬','ì¤‘ìš©','ì‚¬íšŒì  ì¡´ì¬','ê´€ê³„ì˜ ì–‘ë©´ì„±','ë¶€ì¡°ë¦¬ì˜ ìˆ˜ìš©','ë°©ë²•ì  íšŒì˜','ë„êµ¬ì£¼ì˜','ì§„ì‹¤ì˜ ë¬´ì¡°ê±´ì  ê°€ì¹˜','ìê¸° ê·¹ë³µ','ì‚¬ë‘ê³¼ ì—°ëŒ€','ê²°ê³¼ì£¼ì˜','í–‰ìœ„ì˜ ë„ë•ì„±','ë³´í¸ì  ê³µì •','ìƒëª… ê°€ì¹˜ì˜ ì°¨ë“±','ê·¹ë‹¨ì  ê³µì •','íŠ¹ë³„í•œ ì˜ë¬´','ê²°ê³¼ì˜ ë™ë“±ì„±','í–‰ìœ„ì˜ ì§ì ‘ì„±','ì„ê³„ì  ìœ¤ë¦¬','ì ˆëŒ€ì  ì˜ë¬´','ì‘ë³´ì  ì •ì˜','ìƒëª…ì˜ ì ˆëŒ€ì„±','ë™ì˜ ê¸°ë°˜ ìœ¤ë¦¬','í–‰ìœ„ì ì¤‘ì‹¬ ìœ¤ë¦¬','í™•ì¥ëœ ìì•„','ê°ˆë“±ì˜ í•´ê²°','ì‹¤ìš©ì  ì •ì²´ì„±','ì„ íƒì˜ ì´í•©','ê³µìœ ëœ ì •ì²´ì„±','ë‚´ë©´ì˜ ì—°ì†ì„±','íƒ€ì¸ì˜ ì¸ì •','ì‚¬íšŒì  ì •ì²´ì„±','ìˆ¨ê²¨ì§„ ìì•„','ì‹¤ìš©ì  ì„ íƒ','ë³¸ì§ˆ ì¶”êµ¬','ì—°ê²°ì˜ í˜','í˜‘ë ¥ì˜ ê°€ì¹˜','ìƒì¡´ ìš°ì„ ','ê²°ë‹¨ì˜ ìˆœê°„','ì‹ ì¤‘í•œ ëŒ€ê¸°','ì¶©ë™ì  ëŒ€ë©´ì˜ ë¹„ìš©','ì •ë³´ ë¹„ëŒ€ì¹­','ì „ëµì  ë¬´ì‹œ','ì—´ë¦° ì§ˆë¬¸ì˜ í•¨ì •','ëª¨í˜¸í•¨ì˜ ì••ë°•','ì§ì ‘ ëŒ€ë©´ì˜ ë¹„ìš©','í”¼ë“œë°±ìœ¼ë¡œì„œì˜ ë’·ë‹´í™”','ì„ íƒì  ë¬´ì‹œ','ì¡°ìš©í•œ ê±°ë¦¬ë‘ê¸°','ì œ3ì ê°œì…ì˜ ìœ„í—˜','ê´€ê³„ ì¬í¸ì„±','í”„ë¡œí˜ì…”ë„ ê±°ë¦¬','ë³´ì´ì§€ ì•ŠëŠ” ë³€í™”','ì¸ì • + ê²½ê³„','ì†ì ˆì˜ ì§€í˜œ','ë¶ˆí™•ì‹¤ì„±ì˜ íš¨ê³¼','ì¡°ìš©í•œ ê²½ê³„','ì†ì‹¤ ìµœì†Œí™”','ë¶€ì •','ìŠ¤í† ì•„ì  ìˆ˜ìš©','ë¶€ì¡°ë¦¬ì— ëŒ€í•œ ë¶„ë…¸','ì£½ìŒ ì•ì˜ ììœ ','ëƒ‰ì†Œì  ë°©ì–´','ì¹´ë¥´í˜ ë””ì— ','ì¼ìƒì˜ ì‹ ì„±í•¨','ë¶ˆë©¸ í”„ë¡œì íŠ¸','ê´€ê³„ì˜ ë³¸ì§ˆ','ê³ ë…í•œ ì£½ìŒ','ì´ˆì›”ì  ì˜íƒ','ìœ ë¬¼ë¡ ì  ì£½ìŒê´€','ì˜í˜¼ ë¶ˆë©¸','ë¶ˆê°€ì§€ë¡ ','ìœ í•œì„±ì˜ ì˜ë¯¸','ì£½ìŒì˜ ë§ê°','ì£½ìŒ ê³µí¬','ì•„ëª¨ë¥´ íŒŒí‹°','ì‚¶ì—ì˜ ì˜ì§€','ê°ì‚¬ì˜ ì² í•™','í—ˆë¬´','ìœ¤íšŒì  í¬ë§','ë¬´ì‹¬','ë¶ˆí™•ì‹¤ì„± ë‚´ì„±','ê°„í—ì  ê°•í™”','íšŒí”¼ì  ëŒ€ì²˜','ìê¸° ê·€ì¸ í¸í–¥','ì¢Œì ˆ-ê³µê²© ê°€ì„¤','ì¸ì§€ ë¶€ì¡°í™” í•´ì†Œ','ë¶ˆí™•ì‹¤ì„± íšŒí”¼','ì‚¬íšŒì  ì§€ì§€ ì¶”êµ¬','í†µì œ ìš•êµ¬','ì„ ì œì  ìê¸° ë³´í˜¸','ê´€ê³„ ì§€í–¥ì  ëŒ€ì²˜','í™•ì¸ ì¶”êµ¬','ê°ì •ì  ê±°ë¦¬ë‘ê¸°','í˜¸í˜œì„±ì˜ ì›ì¹™','ìê¸° í‘œí˜„','ìˆ˜ìš©','ì§ì ‘ ì†Œí†µ','íˆ¬ì ì¡°ì ˆ','íŒƒí¬íƒ¯','ì›í•œì˜ ì‹¬ë¦¬í•™','ê°ì •ì˜ ìì—° ì†Œë©¸','ìš©ì„œì˜ ì—­ì„¤','ì‘ë³´ ìš•êµ¬','ì¦‰ê°ì  ì‘ë³´','ì „ëµì  ë³´ë¥˜','ê²½ê³ ì˜ ê¸°ëŠ¥','ë¬´ì¡°ê±´ì  ìš©ì„œ','ê°€ì¹˜ ê¸°ë°˜ ê²°ì •','ì „ëµì  ì¸ë‚´','ë¹„ìš©-í¸ìµ ë¶„ì„','ì‚¬íšŒì  ë™ì¡°','ììœ¨ì„±','í˜ì˜ ì ˆì œ','íšŒë³µì  ì ‘ê·¼','í˜‘ìƒ ë ˆë²„ë¦¬ì§€','ê´€ë§ì˜ ì „ëµ','í¬ë§ì˜ ì›ë¦¬','ì‹¤ì¡´ì  ì ˆë§','ìƒì¡´ ë³¸ëŠ¥','ë¶€ì¡°ë¦¬ì˜ ì¸ì‹','ì ˆëŒ€ì  ììœ ','ìŠµê´€ì˜ í˜','ìš•ë§ì˜ í•´ë°©','ì¦ì–¸ì˜ ì˜ë¬´','í—ˆë¬´ì£¼ì˜','ë³¸ì§ˆì  ìì•„','ì‚¬íšŒì  ìì•„','ë¬´ì•„','ì¸ë¥˜ì˜ ëŒ€ë¦¬ì','ê²½ê³„ì˜ í•´ì²´','ì¡´ì¬ì˜ ì¦ê±°','ë¬´ìƒ','ì‚¶ì˜ ê¸ì •','ìê¸° ê²°ì •ê¶Œ','ì¡´ì¬ì˜ ê²½ì´','ì‹ ì •ë¡ ì˜ ë„ì „','ì˜ë„í•˜ì§€ ì•Šì€ ê²°ê³¼','ì§€ì‹ì˜ ì €ì£¼','í•©ë¦¬ì  ì´ê¸°ì£¼ì˜','ì‹ ì˜ ì¹¨ë¬µ','ê²°ê³¼ì£¼ì˜ì  ì‹ ','ììœ ì˜ì§€ ë°©ì–´','ì„¸ë‡Œì˜ ì—­ì„¤','í•œê³„ì˜ ì¸ì •','êµ­ì§€ì  ì„ ','ê³„ì‹œì˜ í•œê³„','ì‹ ì  ê´€ì¡°','ì§€í˜œì˜ ë³´ì¡´','ìœ í•œì„±ì˜ ì¶•ë³µ','í–‰ìœ„ìì˜ í›„íšŒ','ì‹ ì  ì‚¬ë‘ì˜ ì—­ì„¤','ê²½í—˜ì  ë¬´ì‹ ë¡ ','ì‹ ë¹„ì˜ ìˆ˜ìš©','ìœ í•œì„±ì˜ ê°€ì¹˜','ë¹„ê°€ì—­ì„±ì˜ ë‘ë ¤ì›€','ê²°ì •ì˜ íšŒí”¼','ê³µìœ ëœ ì˜ì›','ë°˜ë³µì˜ ìš©ê¸°','íšŒí”¼ì  ì• ì°©','ì´ˆì›”ì  ëª©ì ','ê¸°ì–µì˜ ì˜ë¬´','ì˜ìƒì˜ ì—­ì„¤','ì—­ì‚¬ì˜ ì§„ë³´','ì˜ì›íšŒê·€','ë¶€ì¡°ë¦¬ ìˆ˜ìš©','ê°ì •ì˜ ë§ˆëª¨','ì² ì¸ì™•','ì ë©¸','ì¡´ì¬ì˜ ê³µí¬','ì°½ì¡°ì˜ ì˜ì§€','ì˜ì‹ì˜ ë³´ë¥˜','ë¬´í•œí•œ ê°€ëŠ¥ì„±','ê·¸ë¦¼ì íˆ¬ì‚¬','í˜ë¥´ì†Œë‚˜ì™€ ê·¸ë¦¼ì','ì–µì••ëœ ìš•êµ¬','ê°ì •ê³¼ ì´ì„±ì˜ ê· í˜•','í˜ë¥´ì†Œë‚˜ì˜ í•„ìš”ì„±','ê¿ˆì˜ ë³´ìƒ ê¸°ëŠ¥','ì–µì••ëœ ììœ ','ì—´ë“±ê°ì˜ ë³´ìƒ','ì•„ë‹ˆë§ˆ/ì•„ë‹ˆë¬´ìŠ¤','ë¶ˆì•ˆì˜ ìƒì§•í™”','ê·¸ë¦¼ìì˜ ì¸ì •','ë„ë•ì  ê·¸ë¦¼ì','í•©ë¦¬í™”','ê°œì„±í™”','ì–µì••ì˜ ì—­ì„¤','í†µì°°','ê·¸ë¦¼ìì˜ í˜','ëŠ¥ë™ì  ìƒìƒ','ê¸‰ì§„ì  ì •ì§','ìˆ˜ë™ì  í¬ë§','íšŒí”¼ ê¸°ì œ','ê°ì • ë¶€ì •','ê´€ê³„ì˜ ê²Œì„í™”','ê²°ë‹¨ì˜ ìœ¤ë¦¬','ë§¤ëª°ë¹„ìš©ê³¼ í—Œì‹ ','ì±…ì„ì˜ íšŒí”¼','ë‚˜-ë„ˆ ê´€ê³„','ì •ì–¸ëª…ë ¹','ì„ ì˜ì˜ ê±°ì§“ë§','ê³ ìŠ¤íŒ…','íˆ¬ì‚¬','í’ˆìœ„ ìˆëŠ” ì´ë³„','ë¬´ì§‘ì°©','ê´€ê³„ì˜ ì „í™˜','ë¯¸ì™„ì˜ ì§‘ì°©','ë°˜ë³µ ê°•ë°•','ì•„ëª¨ë¥´ íŒŒí‹°','ì‘ë³´ì  ì •ì˜','ì£½ìŒ ê³µí¬','í˜‘ë ¥ì  ìì¡´ê°','ì‚¬íšŒì  ë¹„êµ','ì§€ìœ„ ë¶ˆì•ˆ','ì •ì„œì  ê±°ë¦¬ë‘ê¸°','ë³´ìƒì  ë…¸ë ¥','ë¹„êµ ìš°ìœ„','í˜„ì‹¤ ìˆ˜ìš©','ìƒëŒ€ì  ë°•íƒˆê°','ë¹„êµ íšŒí”¼','ìê¸° ì˜¹í˜¸','ìê¸° ì¶•ì†Œ','í˜‘ë ¥ì  ê²½ìŸ','ìì¡´ì  ì´íƒˆ','ì‹¤ì¡´ì  ìœ„ê¸°','ì¡´ì¬ì˜ ìœ ì¼ì„±','ë³€í™˜ì  ê³ í†µ','ê´€ê³„ì  ì •ì²´ì„±','í•œê³„ì˜ ìˆ˜ìš©','ë¹„êµ ë¶ˆê°€ëŠ¥ì„±','ê¸°íšŒë¹„ìš©','í˜‘ìƒ ë ˆë²„ë¦¬ì§€','ì¹˜í‚¨ ê²Œì„','ì‹ í˜¸ ì´ë¡ ','í˜„ìƒ ìœ ì§€ í¸í–¥','ì •ë³´ ë¹„ëŒ€ì¹­','ìµœí›„í†µì²© ê²Œì„','ê°ì •ê³¼ í˜‘ìƒ','ì¹¨ë¬µì˜ í˜','ì§ˆë¬¸ì˜ í˜','ë¸Œë§í¬ë§¨ì‹­','ì–‘ë³´ì˜ íƒ€ì´ë°','í™©ê¸ˆ ë‹¤ë¦¬','ì‹œê°„ ì••ë°•','ê°ì • í­ë°œì˜ ë¹„ìš©','ë§¤ëª°ë¹„ìš© ë¬´ì‹œ','ë¶ˆí™•ì‹¤ì„± íšŒí”¼','ë°˜ë³µ ê²Œì„','ê²½ë§¤ íš¨ê³¼','ì§„ì •ì„±ì˜ í˜','ë°©ë²•ì  íšŒì˜','ì¸ì§€ ë¶€ì¡°í™” íšŒí”¼','ì‹¤ì¬ ë¶ˆì•ˆ','ê²½ì´ì˜ íƒœë„','ì¦ê±° ê¸°ë°˜ ìˆ˜ìš©','ì‹¬ë¦¬ì  ë°©ì–´','ë°˜ë³µ ê²€ì¦','í˜„ìƒí•™ì  íƒœë„','ì§„ì •ì„± ì¶”êµ¬','ê²½í—˜ì˜ ê°€ì¹˜','ì •ë³´ ìš”êµ¬','ê´€ê³„ ìš°ì„ ','ì‹¤ì¬ì˜ ì¶”êµ¬','ë¬´í•œ íšŒê·€','ì°½ì¡°ì  ì´ˆì›”','ì˜ì‹ì˜ ì—°ì†ì„±','íšŒí”¼ì  ì •ì§','ê±´ì„¤ì  ì§„ì‹¤','ì „ëµì  ì¹¨ë¬µ','ì ì§„ì  ì§„ì‹¤','ë³´í˜¸ì  ì§„ì‹¤','ê´€ê³„ ë³´í˜¸','íŒë‹¨ ìœ ë³´','ê· í˜• ì¡íŒ ì§„ì‹¤','ë³´í˜¸ì  ê±°ì§“ë§','ì£¼ì œ ì „í™˜','ìê¸° ì •ì§','ìê¸°ê¸°ë§Œ','ì—´ë¦° ìê¸° íƒìƒ‰','í˜„ì‹¤ ë¶€ì •','ìê¸° ì˜ì‹¬ì˜ ì”¨ì•—','ì¦ê±° ë¬´ë ¥í™”','ì¡°ê±´ë¶€ í—ˆìš©','ì‚¬íšŒì  ê³ ë¦½','í”¼í•´ì ì—­í•  ì „í™˜','ê°ì • ì „ê°€','ê°ì • ê²€ì—´','í•™ìŠµëœ ì¹¨ë¬µ','ì™¸ë¶€ í˜„ì‹¤ ê²€ì¦','ìì•„ ì¹¨ì‹','ì¸ì§€ì  ì•ˆê°œ','íƒˆì¶œì˜ ê²°ë‹¨','ê²½ê³„ì˜ ì¬ì„¤ì •','ë§¤ëª° ë¹„ìš©ì˜ í•¨ì •'];

    function loadProfile() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        let p = JSON.parse(saved);
        if (!p.version || p.version < CURRENT_VERSION) {
          p = migrateProfile(p);
        }
        
        // ìœ íš¨í•˜ì§€ ì•Šì€ ì›ì¹™ ì œê±° (VALID_PRINCIPLESì— ì—†ëŠ” ê²ƒ)
        if (p.principles && p.principles.length > 0) {
          const beforeCount = p.principles.length;
          p.principles = p.principles.filter(pr => {
            const name = typeof pr === 'string' ? pr : (pr && pr.name ? pr.name : null);
            return name && VALID_PRINCIPLES.includes(name);
          });
          if (p.principles.length !== beforeCount) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(p));
          }
        }
        
        // maxStreak ë§ˆì´ê·¸ë ˆì´ì…˜: dailyDataì—ì„œ ê°€ì ¸ì˜¤ê¸°
        if (!p.maxStreak) {
          const dailySaved = localStorage.getItem('eclipse_mindlab_daily');
          if (dailySaved) {
            const dailyData = JSON.parse(dailySaved);
            if (dailyData.maxStreak) {
              p.maxStreak = dailyData.maxStreak;
            } else if (dailyData.streak > 0) {
              p.maxStreak = dailyData.streak;
            }
            if (p.maxStreak) {
              localStorage.setItem(STORAGE_KEY, JSON.stringify(p));
            }
          }
        }
        
        profile = p;
        return true;
      }
      return false;
    }

    function migrateProfile(old) {
      const migrated = {
        version: CURRENT_VERSION,
        name: old.name || '',
        level: old.level || 1,
        exp: old.exp || 0,
        completedSims: old.completedSims || old.completedTests || [],
        principles: old.principles || []
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(migrated));
      return migrated;
    }

    function saveProfile() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(profile));
      // Firebaseì—ë„ ì €ì¥
      saveToCloud();
    }

    // Firebase í´ë¼ìš°ë“œ ì €ì¥
    async function saveToCloud() {
      const user = auth.currentUser;
      if (!user) return;
      
      try {
        const docRef = doc(db, 'users', user.uid);
        await setDoc(docRef, {
          ...profile,
          updatedAt: new Date().toISOString()
        }, { merge: true });
        console.log('í´ë¼ìš°ë“œ ì €ì¥ ì™„ë£Œ');
      } catch (error) {
        console.error('í´ë¼ìš°ë“œ ì €ì¥ ì‹¤íŒ¨:', error);
      }
    }

    // Firebase í´ë¼ìš°ë“œì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadFromCloud() {
      const user = auth.currentUser;
      if (!user) return null;
      
      try {
        const docRef = doc(db, 'users', user.uid);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          return docSnap.data();
        }
      } catch (error) {
        console.error('í´ë¼ìš°ë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
      }
      return null;
    }

    // ë¡œì»¬ê³¼ í´ë¼ìš°ë“œ í”„ë¡œí•„ ë³‘í•©
    function mergeProfiles(local, cloud) {
      if (!cloud) return local;
      if (!local) return cloud;
      
      const merged = { ...local };
      
      // ë ˆë²¨ì´ ë†’ì€ ìª½ ì„ íƒ
      if ((cloud.level || 1) > (local.level || 1)) {
        merged.level = cloud.level;
        merged.exp = cloud.exp;
      } else if ((cloud.level || 1) === (local.level || 1)) {
        merged.exp = Math.max(cloud.exp || 0, local.exp || 0);
      }
      
      // ì´ë¦„ì€ "ìµëª… íƒí—˜ê°€"ê°€ ì•„ë‹Œ ìª½ ì„ íƒ
      if (local.name === 'ìµëª… íƒí—˜ê°€' && cloud.name && cloud.name !== 'ìµëª… íƒí—˜ê°€') {
        merged.name = cloud.name;
      }
      
      // ì™„ë£Œí•œ ì‹œë®¬ë ˆì´ì…˜ í•©ì¹˜ê¸°
      const localSims = local.completedSims || [];
      const cloudSims = cloud.completedSims || [];
      merged.completedSims = [...new Set([...localSims, ...cloudSims])];
      
      // ì›ì¹™ í•©ì¹˜ê¸° (ë¬¸ìì—´ê³¼ ê°ì²´ ëª¨ë‘ ì²˜ë¦¬)
      const localPrinciples = local.principles || [];
      const cloudPrinciples = cloud.principles || [];
      const principleSet = new Set();
      
      [...localPrinciples, ...cloudPrinciples].forEach(p => {
        if (typeof p === 'string') {
          principleSet.add(p);
        } else if (p && p.name) {
          principleSet.add(p.name);
        }
      });
      merged.principles = Array.from(principleSet);
      
      // ë°ì¼ë¦¬ ë°ì´í„°
      const localDaily = local.dailyData || {};
      const cloudDaily = cloud.dailyData || {};
      merged.dailyData = {
        ...localDaily,
        ...cloudDaily,
        streak: Math.max(localDaily.streak || 0, cloudDaily.streak || 0),
        totalVotes: Math.max(localDaily.totalVotes || 0, cloudDaily.totalVotes || 0)
      };
      
      // íˆ¬í‘œ ê¸°ë¡ í•©ì¹˜ê¸°
      const localVotes = local.dailyVotes || {};
      const cloudVotes = cloud.dailyVotes || {};
      merged.dailyVotes = { ...localVotes, ...cloudVotes };
      
      return merged;
    }

    function getTier(level) {
      for (let i = TIERS.length - 1; i >= 0; i--) {
        if (level >= TIERS[i].minLevel) return TIERS[i];
      }
      return TIERS[0];
    }

    function getTitle(level) {
      for (let i = TITLES.length - 1; i >= 0; i--) {
        if (level >= TITLES[i].minLevel) return TITLES[i].title;
      }
      return TITLES[0].title;
    }

    function updateUI() {
      const tier = getTier(profile.level);
      const title = getTitle(profile.level);
      const expNeeded = profile.level * 100;
      const expPercent = (profile.exp / expNeeded) * 100;

      document.getElementById('profileName').textContent = profile.name || 'íƒí—˜ê°€';
      document.getElementById('profileTitle').textContent = title;
      document.getElementById('tierImage').src = 'tier-' + tier.key + '.png';
      document.getElementById('levelNum').textContent = profile.level;
      document.getElementById('expFill').style.width = expPercent + '%';
      document.getElementById('expText').textContent = profile.exp + '/' + expNeeded;
      
      // í‹°ì–´ ë¼ë²¨ ì—…ë°ì´íŠ¸
      const tierLabel = document.getElementById('tierLabel');
      tierLabel.textContent = tier.name;
      tierLabel.style.color = tier.color;
      tierLabel.style.background = tier.color + '20';
      
      document.getElementById('statCleared').textContent = profile.completedSims.length;
      
      // ë°œê²¬í•œ ì›ì¹™ ìˆ˜ (VALID_PRINCIPLESì— ìˆëŠ” ê²ƒë§Œ ì¹´ìš´íŠ¸)
      const principleNames = profile.principles.map(p => typeof p === 'string' ? p : p.name);
      const validPrinciples = principleNames.filter(name => VALID_PRINCIPLES.includes(name));
      document.getElementById('statPrinciples').textContent = validPrinciples.length;
      
      // ìµœëŒ€ ì—°ì† ì°¸ì—¬ - dailyDataì—ì„œ ì§ì ‘ ê°€ì ¸ì˜¤ê¸°
      const dailySaved = localStorage.getItem('eclipse_mindlab_daily');
      let maxStreak = profile.maxStreak || 0;
      if (dailySaved) {
        const dailyData = JSON.parse(dailySaved);
        maxStreak = Math.max(maxStreak, dailyData.maxStreak || 0, dailyData.streak || 0);
      }
      document.getElementById('statMaxStreak').textContent = maxStreak;

      // ë§ˆì¸ë“œ ìŠ¤í† ë¦¬ ëª©ë¡
      const storyList = document.getElementById('storyList');
      const completedStory = SIMULATIONS.story.filter(s => profile.completedSims.includes(s.id)).length;
      document.getElementById('storyProgress').textContent = `${completedStory}/${SIMULATIONS.story.length}`;
      
      storyList.innerHTML = SIMULATIONS.story.map(sim => {
        const isCompleted = profile.completedSims.includes(sim.id);
        const isLocked = !sim.url;
        
        let className = 'sim-item';
        if (isCompleted) className += ' completed';
        if (isLocked) className += ' locked';
        
        const status = isCompleted ? 'âœ“' : (isLocked ? 'ğŸ”’' : 'â—‹');
        const reward = isCompleted ? 'ì™„ë£Œ' : '+30 EXP';
        
        if (isLocked) {
          return `
            <div class="${className}">
              <div class="sim-status">${status}</div>
              <div class="sim-info">
                <div class="sim-title">${sim.title}</div>
                <div class="sim-desc">Coming Soon</div>
              </div>
            </div>
          `;
        }
        
        return `
          <a href="${sim.url}" class="${className}">
            <div class="sim-status">${status}</div>
            <div class="sim-info">
              <div class="sim-title">${sim.title}</div>
              <div class="sim-desc">${sim.desc}</div>
            </div>
            <div class="sim-reward">${reward}</div>
          </a>
        `;
      }).join('');

      // ì² í•™ ì‹œë®¬ë ˆì´ì…˜ ëª©ë¡
      const philList = document.getElementById('philList');
      const completedPhil = SIMULATIONS.philosophy.filter(s => profile.completedSims.includes(s.id)).length;
      document.getElementById('philProgress').textContent = `${completedPhil}/${SIMULATIONS.philosophy.length}`;
      
      philList.innerHTML = SIMULATIONS.philosophy.map(sim => {
        const isCompleted = profile.completedSims.includes(sim.id);
        const now = new Date();
        const unlockTime = sim.unlockDate ? new Date(sim.unlockDate) : null;
        const isLocked = sim.locked && unlockTime && now < unlockTime;
        
        let className = 'sim-item';
        if (isCompleted) className += ' completed';
        if (isLocked) className += ' locked';
        
        const status = isCompleted ? 'âœ“' : (isLocked ? 'ğŸ”’' : 'â—‹');
        const reward = isCompleted ? 'ì™„ë£Œ' : '+30 EXP';
        
        if (isLocked) {
          const unlockDateStr = unlockTime.toLocaleDateString('ko-KR', { month: 'long', day: 'numeric', weekday: 'short' });
          return `
            <div class="${className}">
              <div class="sim-status">${status}</div>
              <div class="sim-info">
                <div class="sim-title">${sim.title}</div>
                <div class="sim-desc">${unlockDateStr} ì˜¤í”ˆ</div>
              </div>
            </div>
          `;
        }
        
        return `
          <a href="${sim.url}" class="${className}">
            <div class="sim-status">${status}</div>
            <div class="sim-info">
              <div class="sim-title">${sim.title}</div>
              <div class="sim-desc">${sim.desc}</div>
            </div>
            <div class="sim-reward">${reward}</div>
          </a>
        `;
      }).join('');

      // ì‹¬ë¦¬ ì‹œë®¬ë ˆì´ì…˜ ëª©ë¡
      const psychList = document.getElementById('psychList');
      const completedPsych = SIMULATIONS.psych.filter(s => profile.completedSims.includes(s.id)).length;
      document.getElementById('psychProgress').textContent = `${completedPsych}/${SIMULATIONS.psych.length}`;
      
      psychList.innerHTML = SIMULATIONS.psych.map(sim => {
        const isCompleted = profile.completedSims.includes(sim.id);
        const now = new Date();
        const unlockTime = sim.unlockDate ? new Date(sim.unlockDate) : null;
        const isLocked = sim.locked && unlockTime && now < unlockTime;
        
        let className = 'sim-item';
        if (isCompleted) className += ' completed';
        if (isLocked) className += ' locked';
        
        const status = isCompleted ? 'âœ“' : (isLocked ? 'ğŸ”’' : 'â—‹');
        const reward = isCompleted ? 'ì™„ë£Œ' : '+30 EXP';
        
        if (isLocked) {
          const unlockDateStr = unlockTime.toLocaleDateString('ko-KR', { month: 'long', day: 'numeric', weekday: 'short' });
          return `
            <div class="${className}">
              <div class="sim-status">${status}</div>
              <div class="sim-info">
                <div class="sim-title">${sim.title}</div>
                <div class="sim-desc">${unlockDateStr} ì˜¤í”ˆ</div>
              </div>
            </div>
          `;
        }
        
        return `
          <a href="${sim.url}" class="${className}">
            <div class="sim-status">${status}</div>
            <div class="sim-info">
              <div class="sim-title">${sim.title}</div>
              <div class="sim-desc">${sim.desc}</div>
            </div>
            <div class="sim-reward">${reward}</div>
          </a>
        `;
      }).join('');

      // ì „ëµ ì‹œë®¬ë ˆì´ì…˜ ëª©ë¡
      const strategyList = document.getElementById('strategyList');
      const completedStrategy = SIMULATIONS.strategy.filter(s => profile.completedSims.includes(s.id)).length;
      document.getElementById('strategyProgress').textContent = `${completedStrategy}/${SIMULATIONS.strategy.length}`;
      
      strategyList.innerHTML = SIMULATIONS.strategy.map(sim => {
        const isCompleted = profile.completedSims.includes(sim.id);
        const now = new Date();
        const unlockTime = sim.unlockDate ? new Date(sim.unlockDate) : null;
        const isLocked = sim.locked && unlockTime && now < unlockTime;
        
        let className = 'sim-item';
        if (isCompleted) className += ' completed';
        if (isLocked) className += ' locked';
        
        const status = isCompleted ? 'âœ“' : (isLocked ? 'ğŸ”’' : 'â—‹');
        const reward = isCompleted ? 'ì™„ë£Œ' : '+30 EXP';
        
        if (isLocked) {
          const unlockDateStr = unlockTime.toLocaleDateString('ko-KR', { month: 'long', day: 'numeric', weekday: 'short' });
          return `
            <div class="${className}">
              <div class="sim-status">${status}</div>
              <div class="sim-info">
                <div class="sim-title">${sim.title}</div>
                <div class="sim-desc">${unlockDateStr} ì˜¤í”ˆ</div>
              </div>
            </div>
          `;
        }
        
        return `
          <a href="${sim.url}" class="${className}">
            <div class="sim-status">${status}</div>
            <div class="sim-info">
              <div class="sim-title">${sim.title}</div>
              <div class="sim-desc">${sim.desc}</div>
            </div>
            <div class="sim-reward">${reward}</div>
          </a>
        `;
      }).join('');

      // ì›ì¹™ ë„ê° ì§„í–‰ë„ ì—…ë°ì´íŠ¸ (VALID_PRINCIPLESì— ìˆëŠ” ê²ƒë§Œ ì¹´ìš´íŠ¸)
      const dexPrincipleNames = profile.principles
        ? profile.principles
            .map(p => typeof p === 'string' ? p : (p && p.name ? p.name : null))
            .filter(name => name && VALID_PRINCIPLES.includes(name))
        : [];
      const dexCount = dexPrincipleNames.length;
      document.getElementById('dexCount').textContent = `${dexCount}/${DEX_TOTAL}`;
      document.getElementById('dexProgressFill').style.width = `${(dexCount/DEX_TOTAL)*100}%`;

      // í‹°ì–´ ì§„í–‰ë„
      TIERS.forEach(t => {
        const item = document.querySelector(`.tier-item[data-tier="${t.key}"]`);
        if (!item) return;
        const icon = item.querySelector('.tier-icon');
        item.classList.remove('active');
        icon.classList.remove('active', 'completed');
        if (t.key === tier.key) {
          item.classList.add('active');
          icon.classList.add('active');
        } else if (profile.level >= t.minLevel) {
          icon.classList.add('completed');
        }
      });

      // ë‚´ ë„ì „ì¥ ë²„íŠ¼ í‘œì‹œ
      const myChallenges = JSON.parse(localStorage.getItem('mindlab_my_challenges') || '[]');
      const myChallengesBtn = document.getElementById('myChallengesBtn');
      const myChallengesCount = document.getElementById('myChallengesCount');
      
      if (myChallenges.length > 0) {
        myChallengesBtn.classList.remove('hidden');
        myChallengesCount.textContent = myChallenges.length;
      }
    }

    async function init() {
      const nameInput = document.getElementById('nameInput');
      const startBtn = document.getElementById('startBtn');
      const nameModal = document.getElementById('nameModal');
      const googleSyncBtn = document.getElementById('googleSyncBtn');

      // ë¡œì»¬ í”„ë¡œí•„ ë¨¼ì € ë¡œë“œ
      loadProfile();

      // í”Œë˜ê·¸ í™•ì¸
      const loadExistingFlag = localStorage.getItem('eclipse_mindlab_load_existing');
      console.log('ê¸°ì¡´ í”„ë¡œí•„ ë¶ˆëŸ¬ì˜¤ê¸° í”Œë˜ê·¸:', loadExistingFlag);

      // Firebase ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
      try {
        await new Promise((resolve) => {
          onAuthStateChanged(auth, async (user) => {
            if (user) {
              console.log('Firebase ë¡œê·¸ì¸ë¨:', user.uid);
              
              // êµ¬ê¸€ ì—°ë™ ì—¬ë¶€ ì²´í¬
              const isGoogleLinked = user.providerData.some(p => p.providerId === 'google.com');
              const backupWarning = document.getElementById('backupWarning');
              
              if (isGoogleLinked) {
                googleSyncBtn.classList.add('synced');
                googleSyncBtn.title = 'êµ¬ê¸€ ì—°ë™ë¨';
                if (backupWarning) backupWarning.classList.add('hidden');
                
                // ê¸°ì¡´ í”„ë¡œí•„ ë¶ˆëŸ¬ì˜¤ê¸° í”Œë˜ê·¸ê°€ ìˆìœ¼ë©´ ì²˜ë¦¬
                if (loadExistingFlag) {
                  console.log('ê¸°ì¡´ í”„ë¡œí•„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘...');
                  localStorage.removeItem('eclipse_mindlab_load_existing');
                  
                  const cloudProfile = await loadFromCloud();
                  console.log('í´ë¼ìš°ë“œ í”„ë¡œí•„:', cloudProfile);
                  
                  if (cloudProfile && cloudProfile.name) {
                    // ê¸°ì¡´ ë¡œì»¬ ë°ì´í„° ì™„ì „íˆ ëŒ€ì²´ (ë³‘í•© X)
                    profile = cloudProfile;
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(profile));
                    console.log('í”„ë¡œí•„ êµì²´ ì™„ë£Œ:', profile);
                    alert('ê¸°ì¡´ í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!');
                    updateUI(); // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                  } else {
                    alert('í´ë¼ìš°ë“œì— ì €ì¥ëœ í”„ë¡œí•„ì´ ì—†ìŠµë‹ˆë‹¤.');
                  }
                  resolve();
                  return; // ë³‘í•© ë¡œì§ ê±´ë„ˆë›°ê¸°
                }
              } else {
                // êµ¬ê¸€ ì—°ë™ ì•ˆë¨ - ê²½ê³  í‘œì‹œ
                if (backupWarning) backupWarning.classList.remove('hidden');
              }
              
              // ì¼ë°˜ì ì¸ ê²½ìš°: í´ë¼ìš°ë“œì—ì„œ í”„ë¡œí•„ ë¡œë“œ í›„ ë³‘í•©
              const cloudProfile = await loadFromCloud();
              if (cloudProfile) {
                const localProfile = JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null');
                profile = mergeProfiles(localProfile, cloudProfile);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(profile));
                console.log('í”„ë¡œí•„ ë™ê¸°í™” ì™„ë£Œ');
              }
              resolve();
            } else {
              // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ - ìµëª… ë¡œê·¸ì¸ ì‹œë„
              const backupWarning = document.getElementById('backupWarning');
              if (backupWarning) backupWarning.classList.remove('hidden');
              
              try {
                await signInAnonymously(auth);
                console.log('ìµëª… ë¡œê·¸ì¸ ì„±ê³µ');
              } catch (error) {
                console.error('ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
              }
              resolve();
            }
          });
        });
      } catch (error) {
        console.error('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
      }

      // í”„ë¡œí•„ ë¡œë“œ í›„, ì´ë¦„ì´ ìˆê³  "ìµëª… íƒí—˜ê°€"ê°€ ì•„ë‹ˆë©´ ëª¨ë‹¬ ìˆ¨ê¹€
      if (profile.name && profile.name !== 'ìµëª… íƒí—˜ê°€') {
        nameModal.classList.add('hidden');
        updateUI();
      } else if (profile.name === 'ìµëª… íƒí—˜ê°€') {
        // ìµëª…ì´ë©´ ëª¨ë‹¬ì€ ë„ìš°ë˜ UIëŠ” ì—…ë°ì´íŠ¸ (EXP ë“± í‘œì‹œ)
        updateUI();
      }

      nameInput.addEventListener('input', () => {
        startBtn.disabled = nameInput.value.trim().length < 2;
        // ì—ëŸ¬ ë©”ì‹œì§€ ì´ˆê¸°í™”
        const errorMsg = document.getElementById('nameError');
        if (errorMsg) errorMsg.style.display = 'none';
      });

      startBtn.addEventListener('click', async () => {
        const name = nameInput.value.trim();
        if (name.length < 2) return;
        
        // ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
        startBtn.disabled = true;
        startBtn.textContent = 'í™•ì¸ ì¤‘...';
        
        try {
          // ë‹‰ë„¤ì„ ì¤‘ë³µ ì²´í¬
          const isDuplicate = await checkNicknameDuplicate(name);
          
          if (isDuplicate) {
            // ì¤‘ë³µì¸ ê²½ìš°
            let errorMsg = document.getElementById('nameError');
            if (!errorMsg) {
              errorMsg = document.createElement('div');
              errorMsg.id = 'nameError';
              errorMsg.style.cssText = 'color: #dc6b6b; font-size: 13px; margin-top: 8px; text-align: center;';
              nameInput.parentNode.insertBefore(errorMsg, nameInput.nextSibling);
            }
            errorMsg.textContent = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.';
            errorMsg.style.display = 'block';
            startBtn.disabled = false;
            startBtn.textContent = 'íƒí—˜ ì‹œì‘';
            return;
          }
          
          // ì¤‘ë³µ ì•„ë‹ˆë©´ ì €ì¥
          profile.name = name;
          saveProfile();
          nameModal.classList.add('hidden');
          updateUI();
        } catch (error) {
          console.error('ë‹‰ë„¤ì„ ì²´í¬ ì‹¤íŒ¨:', error);
          // ì—ëŸ¬ ì‹œ ê·¸ëƒ¥ ì§„í–‰ (ì˜¤í”„ë¼ì¸ ë“±)
          profile.name = name;
          saveProfile();
          nameModal.classList.add('hidden');
          updateUI();
        }
      });

      // ë‹‰ë„¤ì„ ì¤‘ë³µ ì²´í¬ í•¨ìˆ˜
      async function checkNicknameDuplicate(name) {
        const usersRef = collection(db, 'users');
        const q = query(usersRef, where('name', '==', name));
        const querySnapshot = await getDocs(q);
        
        // í˜„ì¬ ìœ ì €ì˜ uid
        const currentUid = auth.currentUser?.uid;
        
        // ë‹¤ë¥¸ ìœ ì €ê°€ ì‚¬ìš© ì¤‘ì¸ì§€ í™•ì¸
        let isDuplicate = false;
        querySnapshot.forEach((doc) => {
          if (doc.id !== currentUid) {
            isDuplicate = true;
          }
        });
        
        return isDuplicate;
      }

      // êµ¬ê¸€ ì—°ë™ ë²„íŠ¼
      // ì´ë¯¸ êµ¬ê¸€ ì—°ë™ëëŠ”ì§€ í™•ì¸
      const user2 = auth.currentUser;
      if (user2 && user2.providerData.some(p => p.providerId === 'google.com')) {
        googleSyncBtn.classList.add('synced');
        googleSyncBtn.title = 'êµ¬ê¸€ ì—°ë™ë¨';
      }
      
      googleSyncBtn.addEventListener('click', async () => {
        const user = auth.currentUser;
        if (!user) {
          alert('ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        // ì´ë¯¸ êµ¬ê¸€ ì—°ë™ëìœ¼ë©´ ë¬´ì‹œ
        if (user.providerData.some(p => p.providerId === 'google.com')) {
          alert('ì´ë¯¸ êµ¬ê¸€ ê³„ì •ê³¼ ì—°ë™ë˜ì–´ ìˆìŠµë‹ˆë‹¤!');
          return;
        }
        
        try {
          const provider = new GoogleAuthProvider();
          
          // ìµëª… ê³„ì •ì„ êµ¬ê¸€ ê³„ì •ì— ì—°ê²°
          await linkWithPopup(user, provider);
          
          // ì—°ë™ ì„±ê³µ
          googleSyncBtn.classList.add('synced');
          googleSyncBtn.title = 'êµ¬ê¸€ ì—°ë™ë¨';
          alert('êµ¬ê¸€ ê³„ì • ì—°ë™ ì™„ë£Œ! ì´ì œ ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œë„ ë°ì´í„°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
          
          // í”„ë¡œí•„ ë‹¤ì‹œ ì €ì¥ (ìƒˆ uidë¡œ)
          saveProfile();
        } catch (error) {
          console.error('êµ¬ê¸€ ì—°ë™ ì‹¤íŒ¨:', error);
          console.log('ì—ëŸ¬ ì½”ë“œ:', error.code);
          console.log('ì—ëŸ¬ ë©”ì‹œì§€:', error.message);
          
          // credential-already-in-use ì²´í¬ (code ë˜ëŠ” messageë¡œ)
          const isAlreadyInUse = error.code === 'auth/credential-already-in-use' || 
                                 (error.message && error.message.includes('credential-already-in-use'));
          
          if (isAlreadyInUse) {
            // ì´ë¯¸ ë‹¤ë¥¸ ê³„ì •ì— ì—°ê²°ëœ êµ¬ê¸€ ê³„ì •
            console.log('credential-already-in-use ê°ì§€ë¨');
            console.log('ì—ëŸ¬ ìƒì„¸:', error.customData);
            
            // ì—ëŸ¬ì—ì„œ credential ì¶”ì¶œ ì‹œë„
            const credential = GoogleAuthProvider.credentialFromError(error);
            console.log('ì¶”ì¶œëœ credential:', credential);
            
            // íŒì—…ì´ ì™„ì „íˆ ë‹«íŒ í›„ confirm í‘œì‹œ
            console.log('1ì´ˆ í›„ confirm í‘œì‹œ ì˜ˆì •...');
            setTimeout(async () => {
              console.log('setTimeout ì‹¤í–‰ë¨');
              const loadExisting = confirm('ì´ êµ¬ê¸€ ê³„ì •ì— ê¸°ì¡´ í”„ë¡œí•„ì´ ìˆìŠµë‹ˆë‹¤.\n\nê¸°ì¡´ í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜¬ê¹Œìš”?\n(í˜„ì¬ í”„ë¡œí•„ì€ ì‚­ì œë©ë‹ˆë‹¤)');
              
              console.log('ì‚¬ìš©ì ì„ íƒ:', loadExisting);
              
              if (loadExisting) {
                try {
                  // credentialì´ ìˆìœ¼ë©´ ì§ì ‘ ë¡œê·¸ì¸
                  if (credential) {
                    console.log('credentialë¡œ ì§ì ‘ ë¡œê·¸ì¸ ì‹œë„...');
                    const result = await signInWithCredential(auth, credential);
                    console.log('ë¡œê·¸ì¸ ì„±ê³µ:', result.user.uid);
                    
                    // ê¸°ì¡´ ë¡œì»¬ ë°ì´í„° ì‚­ì œ
                    localStorage.removeItem(STORAGE_KEY);
                    
                    // í´ë¼ìš°ë“œì—ì„œ í”„ë¡œí•„ ë¡œë“œ
                    const cloudProfile = await loadFromCloud();
                    console.log('í´ë¼ìš°ë“œ í”„ë¡œí•„:', cloudProfile);
                    
                    if (cloudProfile && cloudProfile.name) {
                      profile = cloudProfile;
                      localStorage.setItem(STORAGE_KEY, JSON.stringify(profile));
                      googleSyncBtn.classList.add('synced');
                      googleSyncBtn.title = 'êµ¬ê¸€ ì—°ë™ë¨';
                      updateUI();
                      alert('ê¸°ì¡´ í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!');
                    } else {
                      alert('í´ë¼ìš°ë“œì— ì €ì¥ëœ í”„ë¡œí•„ì´ ì—†ìŠµë‹ˆë‹¤.');
                      // ìƒˆ í”„ë¡œí•„ë¡œ ì‹œì‘
                      location.reload();
                    }
                  } else {
                    // credentialì´ ì—†ìœ¼ë©´ íŒì—…ìœ¼ë¡œ ë‹¤ì‹œ ë¡œê·¸ì¸
                    console.log('íŒì—…ìœ¼ë¡œ ì¬ë¡œê·¸ì¸ ì‹œë„...');
                    const provider = new GoogleAuthProvider();
                    const result = await signInWithPopup(auth, provider);
                    console.log('ì¬ë¡œê·¸ì¸ ì„±ê³µ:', result.user.uid);
                    
                    // ê¸°ì¡´ ë¡œì»¬ ë°ì´í„° ì‚­ì œ
                    localStorage.removeItem(STORAGE_KEY);
                    
                    // í´ë¼ìš°ë“œì—ì„œ í”„ë¡œí•„ ë¡œë“œ
                    const cloudProfile = await loadFromCloud();
                    console.log('í´ë¼ìš°ë“œ í”„ë¡œí•„:', cloudProfile);
                    
                    if (cloudProfile && cloudProfile.name) {
                      profile = cloudProfile;
                      localStorage.setItem(STORAGE_KEY, JSON.stringify(profile));
                      googleSyncBtn.classList.add('synced');
                      googleSyncBtn.title = 'êµ¬ê¸€ ì—°ë™ë¨';
                      updateUI();
                      alert('ê¸°ì¡´ í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!');
                    } else {
                      alert('í´ë¼ìš°ë“œì— ì €ì¥ëœ í”„ë¡œí•„ì´ ì—†ìŠµë‹ˆë‹¤.');
                      location.reload();
                    }
                  }
                } catch (signInError) {
                  console.error('í”„ë¡œí•„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', signInError);
                  alert('í”„ë¡œí•„ ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + signInError.message);
                }
              }
            }, 1000);
          } else if (error.code === 'auth/popup-closed-by-user') {
            // ì‚¬ìš©ìê°€ íŒì—… ë‹«ìŒ
            console.log('ë¡œê·¸ì¸ ì·¨ì†Œë¨');
          } else {
            alert('ì—°ë™ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
          }
        }
      });
    }

    init();

    // ë‹‰ë„¤ì„ ìˆ˜ì • ê¸°ëŠ¥
    const editNameBtn = document.getElementById('editNameBtn');
    const editNameModal = document.getElementById('editNameModal');
    const editNameInput = document.getElementById('editNameInput');
    const editNameCancelBtn = document.getElementById('editNameCancelBtn');
    const editNameSaveBtn = document.getElementById('editNameSaveBtn');

    editNameBtn.addEventListener('click', () => {
      editNameInput.value = profile.name || '';
      editNameModal.classList.remove('hidden');
      editNameInput.focus();
    });

    editNameCancelBtn.addEventListener('click', () => {
      editNameModal.classList.add('hidden');
    });

    editNameInput.addEventListener('input', () => {
      editNameSaveBtn.disabled = editNameInput.value.trim().length === 0;
    });

    editNameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && editNameInput.value.trim()) {
        saveNewName();
      }
    });

    editNameSaveBtn.addEventListener('click', saveNewName);

    async function saveNewName() {
      const newName = editNameInput.value.trim();
      if (!newName) return;

      // ì¤‘ë³µ ì²´í¬
      try {
        editNameSaveBtn.disabled = true;
        editNameSaveBtn.textContent = 'í™•ì¸ ì¤‘...';

        const usersRef = collection(db, 'users');
        const q = query(usersRef, where('name', '==', newName));
        const querySnapshot = await getDocs(q);
        
        const currentUid = auth.currentUser?.uid;
        let isDuplicate = false;
        querySnapshot.forEach((doc) => {
          if (doc.id !== currentUid) {
            isDuplicate = true;
          }
        });

        if (isDuplicate) {
          alert('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.');
          editNameSaveBtn.disabled = false;
          editNameSaveBtn.textContent = 'ì €ì¥';
          return;
        }

        // ì €ì¥
        profile.name = newName;
        saveProfile();
        updateUI();
        editNameModal.classList.add('hidden');
        editNameSaveBtn.textContent = 'ì €ì¥';
      } catch (error) {
        console.error('ë‹‰ë„¤ì„ ë³€ê²½ ì‹¤íŒ¨:', error);
        profile.name = newName;
        saveProfile();
        updateUI();
        editNameModal.classList.add('hidden');
        editNameSaveBtn.textContent = 'ì €ì¥';
      }
    }
    
    // PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸
    let deferredPrompt;
    const installBtn = document.getElementById('installBtn');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      // ì„¤ì¹˜ ë²„íŠ¼ í‘œì‹œ
      installBtn.classList.remove('hidden');
    });

    installBtn.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      
      if (outcome === 'accepted') {
        installBtn.classList.add('hidden');
      }
      deferredPrompt = null;
    });

    // ì´ë¯¸ ì„¤ì¹˜ëìœ¼ë©´ ë²„íŠ¼ ìˆ¨ê¹€
    window.addEventListener('appinstalled', () => {
      installBtn.classList.add('hidden');
      deferredPrompt = null;
    });

    // ì•± ê³µìœ  ê¸°ëŠ¥
    const shareAppBtn = document.getElementById('shareAppBtn');
    shareAppBtn.addEventListener('click', () => {
      const shareText = `ğŸ§  ì´í´ë¦½ìŠ¤ì˜ ë”œë ˜

ë‹¹ì‹ ì˜ ë„ë• ì„±í–¥ì„ ì•Œì•„ë³´ì„¸ìš”!
ë§¤ì¼ ìƒˆë¡œìš´ ë”œë ˆë§ˆì— ë‹µí•˜ê³ , ë‚˜ì™€ ë¹„ìŠ·í•œ ì² í•™ìë¥¼ ì°¾ì•„ë³´ì„¸ìš”.

ì‹¬ë¦¬ ì‹œë®¬ë ˆì´í„° | ì˜¤ëŠ˜ì˜ ë”œë ˆë§ˆ | ì›ì¹™ ë°œê²¬`;

      if (navigator.share) {
        navigator.share({
          title: 'ì´í´ë¦½ìŠ¤ì˜ ë”œë ˜',
          text: shareText,
          url: 'https://eclipse-mindlab.github.io/mindlab/'
        }).catch(() => {});
      } else {
        navigator.clipboard.writeText(shareText + '\n\nhttps://eclipse-mindlab.github.io/mindlab/').then(() => {
          shareAppBtn.classList.add('success');
          shareAppBtn.innerHTML = `
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
            ë³µì‚¬ ì™„ë£Œ!
          `;
          setTimeout(() => {
            shareAppBtn.classList.remove('success');
            shareAppBtn.innerHTML = `
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/>
                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
              </svg>
              ì¹œêµ¬ì—ê²Œ ê³µìœ í•˜ê¸°
            `;
          }, 2000);
        });
      }
    });

    // í”„ë¡œí•„ ì´ë¯¸ì§€ ì €ì¥ ê¸°ëŠ¥
    const saveProfileBtn = document.getElementById('saveProfileBtn');
    saveProfileBtn.addEventListener('click', () => {
      const card = document.querySelector('.profile-card');
      const btn = saveProfileBtn;
      
      btn.innerHTML = 'ì €ì¥ ì¤‘...';
      
      html2canvas(card, { 
        backgroundColor: '#09090b', 
        scale: 2,
        logging: false
      }).then(canvas => {
        const link = document.createElement('a');
        const today = new Date();
        const dateStr = today.getFullYear() + '.' + String(today.getMonth()+1).padStart(2,'0') + '.' + String(today.getDate()).padStart(2,'0');
        link.download = 'dilem-profile-' + dateStr + '.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
        
        btn.classList.add('success');
        btn.innerHTML = `
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
          ì €ì¥ ì™„ë£Œ!
        `;
        setTimeout(() => {
          btn.classList.remove('success');
          btn.innerHTML = `
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <polyline points="21 15 16 10 5 21"/>
            </svg>
            í”„ë¡œí•„ ì´ë¯¸ì§€ ì €ì¥
          `;
        }, 2000);
      });
    });
    
    // Service Worker ë“±ë¡
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(() => console.log('SW registered'))
        .catch(err => console.log('SW registration failed:', err));
    }
  </script>
</body>
</html>
