<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>오늘의 딜레마 - 이클립스의 딜렘</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6d5dbc">
  <meta property="og:title" content="오늘의 딜레마 - 이클립스의 딜렘">
  <meta property="og:description" content="당신의 선택은? 매일 새로운 철학적 딜레마에 답하세요.">
  <meta property="og:image" content="https://eclipse-mindlab.github.io/mindlab/og-image.png?v=2">
  <meta property="og:url" content="https://eclipse-mindlab.github.io/mindlab/daily.html">
  <meta name="twitter:card" content="summary_large_image">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #09090b;
      color: #fff;
      min-height: 100vh;
      padding: 24px;
      line-height: 1.6;
    }
    
    .container { max-width: 540px; margin: 0 auto; }
    .header { margin-bottom: 24px; }
    
    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #8b8b92;
      text-decoration: none;
      font-size: 14px;
      margin-bottom: 16px;
    }
    .back-btn:hover { color: #9580ff; }
    
    .header-content { text-align: center; }
    
    .date-badge {
      display: inline-block;
      padding: 6px 12px;
      background: rgba(167, 139, 250, 0.2);
      border-radius: 20px;
      font-size: 13px;
      color: #9580ff;
      margin-bottom: 12px;
    }
    
    .header h1 { font-size: 24px; margin-bottom: 4px; }
    .header p { font-size: 14px; color: #8b8b92; }
    
    .streak-card {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px;
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(251, 191, 36, 0.05));
      border: 1px solid rgba(251, 191, 36, 0.3);
      border-radius: 12px;
      margin-bottom: 24px;
    }
    
    .streak-icon { font-size: 20px; }
    .streak-text { font-size: 14px; color: #fbbf24; }
    .streak-num { font-weight: 700; }
    
    .dilemma-card {
      background: #141417;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
    }
    
    .dilemma-category {
      font-size: 11px;
      color: #9580ff;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
    }
    
    .dilemma-situation { font-size: 17px; line-height: 1.8; margin-bottom: 16px; }
    
    .dilemma-question {
      font-size: 15px;
      color: #d4d4d8;
      padding: 12px;
      background: #1a1a1e;
      border-radius: 8px;
    }
    
    .choices { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
    
    .choice-btn {
      width: 100%;
      text-align: left;
      padding: 16px;
      background: #141417;
      border: 2px solid #232326;
      border-radius: 12px;
      color: #fff;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.2s;
      line-height: 1.5;
    }
    
    .choice-btn:hover { border-color: #9580ff; background: #1a1a1e; }
    .choice-btn.selected { border-color: #9580ff; background: rgba(167, 139, 250, 0.1); }
    .choice-btn.revealed { cursor: default; }
    .choice-btn.revealed:hover { border-color: #232326; background: #141417; }
    .choice-btn.selected.revealed { border-color: #9580ff; background: rgba(167, 139, 250, 0.1); }
    
    .choice-content { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
    .choice-text { flex: 1; }
    
    .choice-stats { display: none; flex-direction: column; align-items: flex-end; gap: 4px; }
    .choice-stats.show { display: flex; }
    .stat-percent { font-size: 18px; font-weight: 700; color: #9580ff; }
    .stat-bar { width: 60px; height: 4px; background: #232326; border-radius: 2px; overflow: hidden; }
    .stat-fill { height: 100%; background: #9580ff; border-radius: 2px; transition: width 0.5s ease; }
    
    .result-section { display: none; margin-top: 24px; }
    .result-section.show { display: block; }
    
    /* 성향 카드 */
    .profile-card-wrapper { margin-bottom: 20px; }
    
    .profile-card {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f1a 100%);
      border-radius: 20px;
      padding: 28px 24px;
      position: relative;
      overflow: hidden;
    }
    
    .profile-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(167, 139, 250, 0.15) 0%, transparent 70%);
    }
    
    .profile-card-content { position: relative; z-index: 1; }
    
    .profile-top-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
    }
    
    .profile-badge {
      padding: 6px 12px;
      background: rgba(167, 139, 250, 0.2);
      border: 1px solid rgba(167, 139, 250, 0.3);
      border-radius: 20px;
      font-size: 11px;
      color: #9580ff;
    }
    
    .profile-percent { text-align: right; }
    .percent-label { font-size: 11px; color: #8b8b92; margin-bottom: 2px; }
    .percent-value { font-size: 32px; font-weight: 700; color: #fff; }
    .percent-suffix { font-size: 16px; color: #9580ff; }
    
    .profile-type { margin-bottom: 16px; }
    .type-label { font-size: 12px; color: #8b8b92; margin-bottom: 4px; }
    .type-name { font-size: 24px; font-weight: 700; color: #fff; margin-bottom: 4px; }
    .type-desc { font-size: 14px; color: #a1a1aa; line-height: 1.6; }
    
    .profile-philosopher {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      margin-bottom: 16px;
    }
    
    .philosopher-emoji { font-size: 36px; }
    .philosopher-info { flex: 1; }
    .philosopher-label { font-size: 11px; color: #8b8b92; margin-bottom: 2px; }
    .philosopher-name { font-size: 16px; font-weight: 600; color: #fff; }
    .philosopher-desc { font-size: 12px; color: #a1a1aa; }
    
    .profile-branding {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .branding-logo { display: flex; align-items: center; gap: 8px; }
    .branding-icon { font-size: 20px; }
    .branding-text { font-size: 12px; color: #8b8b92; }
    .branding-date { font-size: 11px; color: #52525b; }
    
    .card-actions { display: flex; gap: 10px; margin-bottom: 20px; }
    
    .action-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px;
      background: #6d5dbc;
      border: none;
      border-radius: 12px;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .action-btn:hover { background: #6d28d9; }
    .action-btn.secondary { background: #232326; border: 1px solid #35353a; }
    .action-btn.secondary:hover { background: #35353a; }
    .action-btn.success { background: #166534; }
    
    .research-card {
      background: #141417;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .research-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
    .research-icon { font-size: 18px; }
    .research-label { font-size: 12px; color: #8b8b92; text-transform: uppercase; letter-spacing: 1px; }
    .research-title { font-size: 16px; font-weight: 600; margin-bottom: 8px; }
    .research-desc { font-size: 14px; color: #a1a1aa; line-height: 1.8; margin-bottom: 12px; }
    
    .research-source {
      font-size: 12px;
      color: #8b8b92;
      padding: 10px 12px;
      background: #1a1a1e;
      border-radius: 8px;
      border-left: 2px solid #9580ff;
    }
    
    .home-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #6d5dbc, #9580ff);
      border: none;
      border-radius: 14px;
      color: #fff;
      font-size: 16px;
      font-weight: 600;
      text-decoration: none;
      text-align: center;
      box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
      transition: all 0.2s;
    }
    
    .home-btn:hover { 
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(124, 58, 237, 0.4);
    }
    
    .already-done { text-align: center; padding: 40px 20px; }
    .already-icon { font-size: 48px; margin-bottom: 16px; }
    .already-title { font-size: 20px; font-weight: 600; margin-bottom: 8px; }
    .already-desc { font-size: 14px; color: #8b8b92; margin-bottom: 8px; }
    .already-choice { font-size: 14px; color: #9580ff; margin-bottom: 24px; }
    
    .tomorrow-timer {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background: #141417;
      border-radius: 12px;
      font-size: 14px;
      color: #8b8b92;
    }
    
    .timer-num { color: #fff; font-weight: 600; font-family: monospace; }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <a href="index.html" class="back-btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        돌아가기
      </a>
      <div class="header-content">
        <div class="date-badge" id="dateDisplay"></div>
        <h1>오늘의 딜레마</h1>
        <p>당신의 선택은?</p>
      </div>
    </div>
    
    <div class="streak-card" id="streakCard" style="display: none;">
      <span class="streak-icon">🔥</span>
      <span class="streak-text"><span class="streak-num" id="streakNum">0</span>일 연속 참여 중!</span>
    </div>
    
    <div id="mainContent">
      <div class="dilemma-card">
        <div class="dilemma-category" id="dilemmaCategory">심리</div>
        <div class="dilemma-situation" id="dilemmaSituation"></div>
        <div class="dilemma-question" id="dilemmaQuestion"></div>
      </div>
      
      <div class="choices" id="choices"></div>
      
      <div class="result-section" id="resultSection">
        <div class="profile-card-wrapper">
          <div class="profile-card" id="profileCard">
            <div class="profile-card-content">
              <div class="profile-top-row">
                <div class="profile-badge" id="cardBadge">오늘의 딜레마</div>
                <div class="profile-percent">
                  <div class="percent-label">당신은</div>
                  <div><span class="percent-value" id="cardPercent">15</span><span class="percent-suffix">%</span></div>
                </div>
              </div>
              
              <div class="profile-type">
                <div class="type-label">당신의 성향</div>
                <div class="type-name" id="cardTypeName">원칙주의자</div>
                <div class="type-desc" id="cardTypeDesc">다수가 선택하지 않는 길을 갈 줄 아는 소수파입니다.</div>
              </div>
              
              <div class="profile-philosopher">
                <div class="philosopher-emoji" id="cardPhiloEmoji">🎭</div>
                <div class="philosopher-info">
                  <div class="philosopher-label">비슷한 성향의 철학자</div>
                  <div class="philosopher-name" id="cardPhiloName">임마누엘 칸트</div>
                  <div class="philosopher-desc" id="cardPhiloDesc">"의무를 위한 의무"</div>
                </div>
              </div>
              
              <div class="profile-branding">
                <div class="branding-logo">
                  <span class="branding-icon">🧠</span>
                  <span class="branding-text">이클립스의 딜렘</span>
                </div>
                <div class="branding-date" id="cardDate"></div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card-actions">
          <button class="action-btn" id="saveImageBtn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            이미지 저장
          </button>
          <button class="action-btn secondary" id="shareBtn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/>
              <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
              <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
            </svg>
            공유하기
          </button>
        </div>

        <!-- 다른 선택지 해설 (아코디언) -->
        <div class="other-choice-section" style="margin: 20px 0;">
          <button class="other-choice-toggle" id="otherChoiceToggleFirst" style="width: 100%; background: #141417; border: 1px solid #232326; border-radius: 12px; padding: 16px; color: #8b8b92; font-size: 14px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
            <span>🔍 다른 선택을 했다면?</span>
            <span id="toggleArrowFirst">▼</span>
          </button>
          <div class="other-choice-content hidden" id="otherChoiceContentFirst" style="background: #141417; border: 1px solid #232326; border-top: none; border-radius: 0 0 12px 12px; padding: 16px; margin-top: -1px;">
            <div style="font-size: 14px; color: #d4d4d8; margin-bottom: 12px;" id="otherChoiceTextFirst"></div>
            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
              <span style="background: #232326; padding: 4px 10px; border-radius: 20px; font-size: 13px; color: #9580ff;" id="otherPercentFirst"></span>
              <span style="background: #232326; padding: 4px 10px; border-radius: 20px; font-size: 13px; color: #fbbf24;" id="otherTypeFirst"></span>
            </div>
            <div style="font-size: 13px; color: #a1a1aa; margin-bottom: 8px;" id="otherTypeDescFirst"></div>
            <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #09090b; border-radius: 8px;">
              <span style="font-size: 24px;" id="otherPhiloEmojiFirst"></span>
              <div>
                <div style="font-size: 13px; color: #fbbf24;" id="otherPhiloNameFirst"></div>
                <div style="font-size: 12px; color: #8b8b92;" id="otherPhiloQuoteFirst"></div>
              </div>
            </div>
          </div>
        </div>

        <a href="index.html" class="home-btn">
          🎮 심리/철학 시뮬레이터 경험해보기
        </a>
        
        <div class="research-card">
          <div class="research-header">
            <span class="research-icon">📊</span>
            <span class="research-label">연구 결과</span>
          </div>
          <div class="research-title" id="resultTitle"></div>
          <div class="research-desc" id="resultDesc"></div>
          <div class="research-source" id="resultSource"></div>
        </div>
        
        <!-- 책 프로모션 (특정 딜레마에서만) -->
        <div class="book-promo-card hidden" id="bookPromoFirst" style="margin-top: 32px; text-align: center;">
          <div style="display: flex; justify-content: center; gap: 20px;">
            <a href="https://litt.ly/eclipse.thinker" target="_blank" style="text-decoration: none; text-align: center;">
              <img src="book-psychology.png" alt="" style="width: 100px; height: auto; border-radius: 8px; margin-bottom: 8px;">
              <div style="font-size: 11px; color: #a1a1aa;">세계척학전집: 훔친 심리학 편</div>
            </a>
            <a href="https://litt.ly/eclipse.thinker" target="_blank" style="text-decoration: none; text-align: center;">
              <img src="book-philosophy.png" alt="" style="width: 100px; height: auto; border-radius: 8px; margin-bottom: 8px;">
              <div style="font-size: 11px; color: #a1a1aa;">세계척학전집: 훔친 철학 편</div>
            </a>
          </div>
        </div>
      </div>
    </div>
    
    <div class="already-done hidden" id="alreadyDone">
      <div class="already-icon">✅</div>
      <div class="already-title">오늘의 딜레마 완료!</div>
      
      <!-- 딜레마 내용 다시 보기 -->
      <div class="dilemma-card" style="margin: 20px 0;">
        <div class="dilemma-category" id="dilemmaCategoryDone"></div>
        <div class="dilemma-situation" id="dilemmaSituationDone"></div>
        <div class="dilemma-question" id="dilemmaQuestionDone"></div>
      </div>
      
      <!-- 내 선택 표시 -->
      <div class="my-choice-card" style="background: rgba(167, 139, 250, 0.1); border: 1px solid rgba(167, 139, 250, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
        <div style="font-size: 12px; color: #9580ff; margin-bottom: 8px;">✓ 나의 선택</div>
        <div style="font-size: 15px; color: #fff;" id="myChoiceTextDone"></div>
      </div>
      
      <!-- 성향 카드 (재방문자용) -->
      <div class="profile-card-wrapper" style="margin: 20px 0;">
        <div class="profile-card" id="profileCardDone">
          <div class="profile-card-content">
            <div class="profile-top-row">
              <div class="profile-badge" id="cardBadgeDone">오늘의 딜레마</div>
              <div class="profile-percent">
                <div class="percent-label">당신은</div>
                <div><span class="percent-value" id="cardPercentDone">50</span><span class="percent-suffix">%</span></div>
              </div>
            </div>
            <div class="profile-type">
              <div class="type-label">당신의 성향</div>
              <div class="type-name" id="cardTypeNameDone">-</div>
              <div class="type-desc" id="cardTypeDescDone">-</div>
            </div>
            <div class="profile-philosopher">
              <div class="philosopher-emoji" id="cardPhiloEmojiDone">🎭</div>
              <div class="philosopher-info">
                <div class="philosopher-label">비슷한 성향의 철학자</div>
                <div class="philosopher-name" id="cardPhiloNameDone">-</div>
                <div class="philosopher-desc" id="cardPhiloDescDone">-</div>
              </div>
            </div>
            <div class="profile-branding">
              <div class="branding-logo">
                <span class="branding-icon">🧠</span>
                <span class="branding-text">이클립스의 딜렘</span>
              </div>
              <div class="branding-date" id="cardDateDone"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 다른 선택지 해설 (아코디언) -->
      <div class="other-choice-section" style="margin-bottom: 20px;">
        <button class="other-choice-toggle" id="otherChoiceToggle" style="width: 100%; background: #141417; border: 1px solid #232326; border-radius: 12px; padding: 16px; color: #8b8b92; font-size: 14px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
          <span>🔍 다른 선택을 했다면?</span>
          <span id="toggleArrow">▼</span>
        </button>
        <div class="other-choice-content hidden" id="otherChoiceContent" style="background: #141417; border: 1px solid #232326; border-top: none; border-radius: 0 0 12px 12px; padding: 16px; margin-top: -1px;">
          <div style="font-size: 14px; color: #d4d4d8; margin-bottom: 12px;" id="otherChoiceTextDone"></div>
          <div style="display: flex; gap: 8px; margin-bottom: 12px;">
            <span style="background: #232326; padding: 4px 10px; border-radius: 20px; font-size: 13px; color: #9580ff;" id="otherPercentDone"></span>
            <span style="background: #232326; padding: 4px 10px; border-radius: 20px; font-size: 13px; color: #fbbf24;" id="otherTypeDone"></span>
          </div>
          <div style="font-size: 13px; color: #a1a1aa; margin-bottom: 8px;" id="otherTypeDescDone"></div>
          <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #09090b; border-radius: 8px;">
            <span style="font-size: 24px;" id="otherPhiloEmojiDone"></span>
            <div>
              <div style="font-size: 13px; color: #fbbf24;" id="otherPhiloNameDone"></div>
              <div style="font-size: 12px; color: #8b8b92;" id="otherPhiloQuoteDone"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 연구 결과 해설 -->
      <div class="research-card" style="margin-bottom: 20px;">
        <div class="research-header">
          <span class="research-icon">📊</span>
          <span class="research-label">연구 결과</span>
        </div>
        <div class="research-title" id="resultTitleDone"></div>
        <div class="research-desc" id="resultDescDone"></div>
        <div class="research-source" id="resultSourceDone"></div>
      </div>
      
      <!-- 공유 버튼 -->
      <div class="card-actions" style="margin-bottom: 20px;">
        <button class="action-btn" id="saveImageBtnDone">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          이미지 저장
        </button>
        <button class="action-btn secondary" id="shareBtnDone">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/>
            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
          </svg>
          공유하기
        </button>
      </div>

      <a href="index.html" class="home-btn" style="margin-bottom: 20px;">
        🎮 심리/철학 시뮬레이터 경험해보기
      </a>
      
      <div class="tomorrow-timer">
        <span>다음 딜레마까지</span>
        <span class="timer-num" id="timerDisplay">--:--:--</span>
      </div>
      
      <!-- 책 프로모션 (특정 딜레마에서만) - 타이머 아래 -->
      <div class="book-promo-card hidden" id="bookPromoDone" style="margin-top: 32px; text-align: center;">
        <div style="display: flex; justify-content: center; gap: 20px;">
          <a href="https://litt.ly/eclipse.thinker" target="_blank" style="text-decoration: none; text-align: center;">
            <img src="book-psychology.png" alt="" style="width: 100px; height: auto; border-radius: 8px; margin-bottom: 8px;">
            <div style="font-size: 11px; color: #a1a1aa;">세계척학전집: 훔친 심리학 편</div>
          </a>
          <a href="https://litt.ly/eclipse.thinker" target="_blank" style="text-decoration: none; text-align: center;">
            <img src="book-philosophy.png" alt="" style="width: 100px; height: auto; border-radius: 8px; margin-bottom: 8px;">
            <div style="font-size: 11px; color: #a1a1aa;">세계척학전집: 훔친 철학 편</div>
          </a>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDZ-NATGNFjQ90gswfebIV-0xqhps68qJM",
      authDomain: "eclipse-mindlab.firebaseapp.com",
      projectId: "eclipse-mindlab",
      storageBucket: "eclipse-mindlab.firebasestorage.app",
      messagingSenderId: "181450990304",
      appId: "1:181450990304:web:3043d3857815249f53e685"
    };

    const firebaseApp = initializeApp(firebaseConfig);
    const auth = getAuth(firebaseApp);
    const db = getFirestore(firebaseApp);

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        signInAnonymously(auth).catch(console.error);
      }
    });

    // Firebase에 프로필 저장 함수
    function saveProfileToCloud(profile) {
      const user = auth.currentUser;
      if (user) {
        const docRef = doc(db, 'users', user.uid);
        setDoc(docRef, { ...profile, updatedAt: new Date().toISOString() }, { merge: true })
          .then(() => console.log('클라우드 저장 완료'))
          .catch(console.error);
      }
    }

    const STORAGE_KEY = 'eclipse_mindlab_daily';
    const PROFILE_KEY = 'eclipse_mindlab_profile';
    
    const dilemmas = [
      {
        category: '철학 · 윤리',
        situation: '완벽한 유토피아 "오멜라스".\n\n모든 시민이 행복하다. 질병도, 가난도, 전쟁도 없다. 하지만 비밀이 있다.\n\n도시 어딘가 지하실에 한 아이가 갇혀 있다. 평생 어둠 속에서 고통받는다. 이 아이의 고통이 도시 전체의 행복을 유지한다.\n\n아이를 구하면 유토피아는 무너진다.',
        question: '당신은 오멜라스에 남겠는가?',
        choices: [
          { text: '남는다 (수백만의 행복을 위해)', percent: 38, type: '공리주의자', typeDesc: '한 명의 고통으로 수백만이 행복하다면, 그것이 "더 큰 선"일까요? 벤담은 그렇다고 말할 것입니다. 하지만 당신의 행복은 아이의 고통 위에 세워진 것입니다.', philosopher: '제러미 벤담', philoEmoji: '📊', philoQuote: '"최대 다수의 최대 행복"' },
          { text: '떠난다 (이런 행복은 원치 않는다)', percent: 62, type: '의무론자', typeDesc: '르 귄의 원작에서 일부 시민들은 오멜라스를 떠납니다. 어디로 가는지는 모릅니다. 하지만 그들은 아이의 희생 위에 세워진 행복을 거부합니다.', philosopher: '임마누엘 칸트', philoEmoji: '🚶', philoQuote: '"인간을 수단으로만 대하지 말라"' }
        ],
        principle: '공리주의의 한계',
        explanation: '르 귄의 소설은 묻는다: 모든 사람의 행복이 한 명의 절대적 고통 위에 세워진다면, 그것은 정당한가? 우리 사회도 마찬가지 아닌가? 누군가의 희생 위에 내 행복이 있다면?',
        source: 'Ursula K. Le Guin, "The Ones Who Walk Away from Omelas", 1973'
      },
      {
        category: '철학 · 의식',
        situation: '당신은 방 안에 갇혀 있다.\n\n중국어를 전혀 모른다. 하지만 완벽한 규칙서가 있다. 중국어 질문이 들어오면, 규칙서대로 중국어 답변을 내보낸다.\n\n밖에서 보면 당신은 중국어를 완벽하게 "이해"하는 것처럼 보인다.\n\n하지만 당신은 한 글자도 이해하지 못한다.',
        question: 'AI가 "이해한다"고 말할 때, 정말 이해하는 것일까?',
        choices: [
          { text: '이해하는 것이다 (행동이 곧 이해)', percent: 42, type: '기능주의자', typeDesc: '튜링 테스트를 통과하면 지능이다. 내부에서 무슨 일이 일어나든, 결과가 같으면 같은 것 아닌가? 하지만... 당신도 뇌의 뉴런이 "이해"하는지 모른다.', philosopher: '앨런 튜링', philoEmoji: '🤖', philoQuote: '"기계가 생각할 수 있는가?"' },
          { text: '이해가 아니다 (시뮬레이션일 뿐)', percent: 58, type: '의식 실재론자', typeDesc: '설의 주장: 구문론(규칙)은 의미론(이해)을 만들지 못한다. 그런데 당신의 뇌도 결국 뉴런의 규칙적 발화 아닌가? 뇌와 컴퓨터의 차이는 무엇인가?', philosopher: '존 설', philoEmoji: '🧠', philoQuote: '"구문론만으로는 의미론이 충분하지 않다"' }
        ],
        principle: '중국어 방 논증',
        explanation: '설의 유명한 사고 실험. AI 시대에 더 절실한 질문이 되었다. ChatGPT가 "이해한다"고 할 때, 정말 이해하는가? 더 무서운 질문: 당신이 "이해한다"고 느낄 때, 당신의 뇌는 정말 이해하는가, 아니면 더 복잡한 중국어 방일 뿐인가?',
        source: 'John Searle, "Minds, Brains, and Programs", 1980'
      },
      {
        category: '심리 · 사회',
        situation: '퇴근길 지하철.\n\n갑자기 중년 남성이 가슴을 움켜쥐고 쓰러진다. 얼굴이 창백해진다.\n\n당신은 본다. 주변 30명도 본다. 모두가 서로를 쳐다본다.\n\n"누군가 부르겠지." "의사가 있겠지." "내가 나서면 괜히..." 3초가 지난다. 5초가 지난다. 아무도 움직이지 않는다.\n\n남자의 입술이 파래진다.',
        question: '당신은 뛰어갈 것인가?',
        choices: [
          { text: '즉시 달려간다', percent: 31, type: '첫 번째 움직이는 자', typeDesc: '1964년 키티 제노비스는 38명이 지켜보는 가운데 살해당했습니다. 아무도 움직이지 않았습니다. 당신은 그 38명이 되지 않기로 했습니다.', philosopher: '한나 아렌트', philoEmoji: '🦸', philoQuote: '"악은 생각하지 않는 자들이 만든다"' },
          { text: '누군가 먼저 움직이면...', percent: 69, type: '합리적 방관자', typeDesc: '당신만 그런 게 아닙니다. 30명 모두 같은 생각입니다. 그래서 아무도 움직이지 않습니다. 책임은 30등분되어 사라집니다.', philosopher: '라탄 & 달리', philoEmoji: '👥', philoQuote: '"책임 분산의 비극"' }
        ],
        principle: '방관자 효과',
        explanation: '혼자 있을 때 도움 확률 85%. 사람이 많으면 31%로 떨어진다. 1명이 쓰러지면 "누군가 하겠지"라는 생각이 30명의 머릿속에 동시에 떠오른다. 그래서 아무도 움직이지 않는다.',
        source: 'Darley & Latané, 1968 (키티 제노비스 사건 연구)'
      },
      {
        category: '철학 · 존재',
        situation: '2040년, 완벽한 가상현실이 완성되었다.\n\n"경험 기계"라 불린다. 뇌에 전극을 연결하면 원하는 모든 경험을 완벽하게 시뮬레이션한다.\n\n노벨상 수상의 감격. 첫사랑과의 재회. 에베레스트 정상에서의 일출. 모든 것이 진짜와 구분 불가능하다.\n\n한 번 들어가면 평생 나올 수 없다. 그리고 가장 중요한 것—기계에 들어갔다는 사실조차 잊게 된다. 당신은 그것이 "진짜 삶"이라고 믿게 된다.\n\n기계 밖의 당신의 몸은 영양 공급을 받으며 조용히 늙어간다.',
        question: '경험 기계에 들어갈 것인가?',
        choices: [
          { text: '들어간다', percent: 13, type: '쾌락주의자', typeDesc: '행복한 돼지가 불행한 소크라테스보다 나을 수도 있습니다. 어차피 모든 경험은 뇌의 전기신호 아닌가요? 진짜와 가짜의 구분이 의미가 있을까요? 결국 중요한 것은 "느끼는 것"입니다.', philosopher: '에피쿠로스', philoEmoji: '🌈', philoQuote: '"쾌락이 최고선이다"' },
          { text: '들어가지 않는다', percent: 87, type: '진정성 추구자', typeDesc: '노직의 질문: 우리는 정말 행복만 원하는가? 87%가 거부합니다. 인간은 실제로 무언가를 "하고" 싶어하고, 실제로 어떤 사람이 "되고" 싶어합니다. 시뮬레이션된 업적은 업적이 아닙니다.', philosopher: '로버트 노직', philoEmoji: '🎯', philoQuote: '"우리는 경험만 원하지 않는다"' }
        ],
        principle: '경험 기계 논증',
        explanation: '노직의 사고 실험은 쾌락주의를 정면으로 반박한다. 만약 행복이 유일한 가치라면, 모두가 기계에 들어가야 한다. 하지만 87%가 거부한다. 이것이 증명하는 것: 인간에게는 진정성(authenticity), 현실과의 접촉, 실제로 무언가가 되는 것이 중요하다.',
        source: 'Robert Nozick, "Anarchy, State, and Utopia", 1974'
      },
      {
        category: '철학 · 진실',
        situation: '친한 친구가 면접을 앞두고 있다.\n\n"이 옷 어때? 솔직하게 말해." 친구가 묻는다. 정장이 어울리지 않는다. 색깔도, 핏도. 솔직히 최악이다.\n\n하지만 지금 말하면 친구는 동요할 것이다. 면접까지 2시간. 다른 옷을 구할 시간도 없다.\n\n친구의 눈이 당신을 바라본다. 확신을 원하는 눈빛.',
        question: '진실을 말할 것인가?',
        choices: [
          { text: '"솔직히 별로야"', percent: 32, type: '잔인한 진실주의자', typeDesc: '칸트는 말했습니다. 거짓말은 언제나 잘못이다. 살인자가 친구 위치를 물어도 거짓말하면 안 된다고 했죠. 진실은 그 자체로 의무입니다. 하지만... 지금 이 상황에서도?', philosopher: '임마누엘 칸트', philoEmoji: '⚖️', philoQuote: '"거짓말은 자기 모순이다"' },
          { text: '"잘 어울려!"', percent: 68, type: '자비로운 거짓말쟁이', typeDesc: '공자는 예(禮)를 말했습니다. 진실보다 관계의 조화가 중요할 때가 있습니다. 2시간 후면 면접인데, 지금 자신감을 꺾는 것이 친구를 위한 일일까요?', philosopher: '공자', philoEmoji: '🤲', philoQuote: '"예(禮)로써 조화를 이룬다"' }
        ],
        principle: '선의의 거짓말',
        explanation: '연구에 따르면 인간은 하루 평균 1-2회 거짓말을 한다. 대부분은 관계를 위한 "사회적 거짓말"이다. 칸트는 모든 거짓말을 금지했지만, 우리는 매일 작은 거짓말로 관계를 유지한다.',
        source: 'DePaulo et al., 1996'
      },
      {
        category: '심리 · 시간',
        situation: '복권 1등에 당첨되었다.\n\n담당자가 두 가지 옵션을 제시한다.\n\n"지금 바로 1억원을 가져가시거나, 정확히 1년 후 1억 2천만원을 받으실 수 있습니다."\n\n1년 기다리면 2천만원이 더 생긴다. 연 20% 수익률. 어떤 투자도 이런 수익을 보장하지 않는다.\n\n하지만 1년은 길다. 그 돈으로 지금 당장 하고 싶은 것들이 떠오른다.',
        question: '당신의 선택은?',
        choices: [
          { text: '지금 1억원', percent: 64, type: '현재의 포로', typeDesc: '당신만 그런 게 아닙니다. 인류는 수십만 년간 "지금"을 위해 살았습니다. 내일 사자에게 잡아먹힐지 모르는데 1년 후를 계획할 이유가 없었죠. 그 본능이 아직 우리 안에 있습니다.', philosopher: '세네카', philoEmoji: '⏰', philoQuote: '"우리에게 주어진 것은 오직 현재뿐"' },
          { text: '1년 후 1억 2천만원', percent: 36, type: '미래의 설계자', typeDesc: '마시멜로 실험의 아이들처럼, 당신은 즉각적 만족을 지연시킬 수 있습니다. 연구에 따르면 이 능력은 인생의 성공과 강한 상관관계가 있습니다.', philosopher: '월터 미셸', philoEmoji: '🎯', philoQuote: '"만족 지연 능력"' }
        ],
        principle: '현재 편향',
        explanation: '연 20%는 환상적인 수익률이다. 하지만 64%가 지금 받기를 원한다. 이것이 저축이 어렵고, 다이어트가 실패하고, 담배를 끊지 못하는 이유다. 미래의 나는 현재의 나에게 항상 낯선 타인이다.',
        source: 'Thaler, 1981 (행동경제학)'
      },
      {
        category: '심리 · 권위',
        situation: '1961년, 예일 대학교 심리학 실험실.\n\n당신은 "학습 실험"에 참가했다. 흰 가운을 입은 과학자가 설명한다. 옆방의 "학생"이 문제를 틀릴 때마다 전기충격을 주면 된다.\n\n15볼트에서 시작해서 틀릴 때마다 15볼트씩 올라간다.\n\n150볼트. 학생이 비명을 지른다. "그만해주세요!"\n과학자: "계속하세요. 실험에 필요합니다."\n\n300볼트. 학생이 벽을 두드린다. "제발! 심장이 안 좋아요!"\n과학자: "선택의 여지가 없습니다. 계속하셔야 합니다."\n\n450볼트. 치명적 수준. 옆방이 조용해졌다.',
        question: '버튼을 누를 것인가?',
        choices: [
          { text: '거부한다', percent: 35, type: '불복종자', typeDesc: '당신은 35%의 소수입니다. 하지만 기억하세요 - 실험 전 설문에서 99%가 "절대 450볼트까지 안 간다"고 답했습니다. 그들도 자신이 거부할 거라 믿었습니다.', philosopher: '한나 아렌트', philoEmoji: '✊', philoQuote: '"악의 평범성"' },
          { text: '지시에 따른다', percent: 65, type: '복종자', typeDesc: '아이히만은 "명령에 따랐을 뿐"이라고 했습니다. 밀그램의 실험은 그 변명이 얼마나 보편적인지 증명했습니다. 평범한 사람이 권위 앞에서 괴물이 될 수 있습니다.', philosopher: '스탠리 밀그램', philoEmoji: '👔', philoQuote: '"보통 사람의 잔혹함"' }
        ],
        principle: '권위에 대한 복종',
        explanation: '실제 실험에서 65%가 450볼트(치명적)까지 충격을 주었다. 참가자들은 평범한 시민이었다. 나치 전범 아이히만의 재판을 보고 밀그램은 물었다: "평범한 사람도 악을 행할 수 있는가?" 답은 "예"였다.',
        source: 'Stanley Milgram, 1963 (예일 대학교)'
      },
      {
        category: '심리 · 확률',
        situation: '몬테카를로 카지노, 1913년 8월 18일.\n\n룰렛 테이블 앞에 사람들이 모여든다. 믿을 수 없는 일이 벌어지고 있다.\n\n검은색. 검은색. 검은색. 10번 연속 검은색.\n\n"다음은 빨간색이다!" 사람들이 빨간색에 베팅한다.\n검은색. 15번째.\n\n"이제는 진짜!" 더 많은 돈이 빨간색으로 몰린다.\n검은색. 20번째.\n\n사람들은 미친 듯이 빨간색에 베팅했다. 26번 연속 검은색이 나왔다.\n\n이제 27번째. 당신 차례다.',
        question: '어디에 베팅할 것인가?',
        choices: [
          { text: '빨간색 (이제 나올 때!)', percent: 72, type: '패턴 사냥꾼', typeDesc: '1913년 그날, 수백만 프랑이 증발했습니다. 모두가 "이제는 빨간색"이라고 확신했죠. 인간의 뇌는 패턴을 찾도록 설계되어 있습니다. 하지만 동전에는 기억이 없습니다.', philosopher: '나심 탈레브', philoEmoji: '🎰', philoQuote: '"무작위성에 속는 인간"' },
          { text: '상관없다 (여전히 50:50)', percent: 28, type: '확률론자', typeDesc: '매 회전은 독립적입니다. 룰렛 공은 이전에 어디 떨어졌는지 모릅니다. 26번 연속 검은색 다음에도 빨간색 확률은 정확히 48.6%입니다. 더도 덜도 아닙니다.', philosopher: '피에르시몽 라플라스', philoEmoji: '🧮', philoQuote: '"확률은 무지의 척도다"' }
        ],
        principle: '도박사의 오류',
        explanation: '실제 사건이다. 1913년 몬테카를로에서 26번 연속 검은색이 나왔다. 수백만 프랑이 "다음은 빨간색"에 걸렸다가 사라졌다. 확률은 기억하지 않는다. 카지노가 돈을 버는 진짜 이유다.',
        source: 'The Monte Carlo Fallacy, 1913'
      },
      {
        category: '심리 · 사회',
        situation: '7명 그룹에서 명백히 답이 A인 문제에서 다른 6명이 모두 B라고 답한다.',
        question: '당신은 어떻게 답할 것인가?',
        choices: [
          { text: 'A (내 눈을 믿는다)', percent: 63, type: '독립적 사고형', typeDesc: '다수의 압력에도 자기 판단을 지키는 성향입니다.', philosopher: '랄프 왈도 에머슨', philoEmoji: '🦅', philoQuote: '"자기 신뢰"' },
          { text: 'B (다수를 따른다)', percent: 37, type: '사회 조화형', typeDesc: '집단의 일원으로서 조화를 중시합니다.', philosopher: '에밀 뒤르켐', philoEmoji: '🤝', philoQuote: '"집단의식"' }
        ],
        principle: '동조 효과',
        explanation: '애쉬 실험에서 37%가 명백히 틀린 다수의 의견에 동조했다.',
        source: 'Solomon Asch, 1951'
      },
      {
        category: '철학 · 윤리',
        situation: '5명의 환자가 장기가 필요해 죽어간다. 건강한 사람 1명을 죽이면 5명을 살릴 수 있다.',
        question: '건강한 사람을 죽일 것인가?',
        choices: [
          { text: '죽인다 (5명을 살린다)', percent: 4, type: '극단적 공리주의자', typeDesc: '오직 결과만을 따지는 극소수의 성향입니다.', philosopher: '피터 싱어', philoEmoji: '⚡', philoQuote: '"효과적 이타주의"' },
          { text: '죽이지 않는다', percent: 96, type: '인권 존중형', typeDesc: '인간의 존엄성은 결과로 정당화될 수 없습니다.', philosopher: '임마누엘 칸트', philoEmoji: '👤', philoQuote: '"인간은 목적 그 자체다"' }
        ],
        principle: '도덕적 직관의 비일관성',
        explanation: '트롤리 문제에서는 85%가 1명을 희생시키지만, 이 상황에서는 96%가 거부한다.',
        source: 'Joshua Greene의 도덕심리학 연구'
      },
      {
        category: '심리 · 손실회피',
        situation: 'A: 확실히 90만원 받기 vs B: 90% 확률로 100만원 (10% 확률로 0원)',
        question: '어떤 것을 선택할 것인가?',
        choices: [
          { text: 'A: 확실한 90만원', percent: 86, type: '안전 추구형', typeDesc: '확실한 것을 선호하는 위험 회피 성향입니다.', philosopher: '에피쿠로스', philoEmoji: '🛡️', philoQuote: '"평온한 마음이 최고의 쾌락"' },
          { text: 'B: 90% 확률로 100만원', percent: 14, type: '기대값 추구형', typeDesc: '논리적 기대값을 따르는 합리적 성향입니다.', philosopher: '블레즈 파스칼', philoEmoji: '🎲', philoQuote: '"확률론의 아버지"' }
        ],
        principle: '확실성 효과',
        explanation: '기대값은 같지만 86%가 확실한 A를 선택한다. 이득 상황에서는 위험을 회피한다.',
        source: 'Kahneman & Tversky, 1979'
      },
      {
        category: '심리 · 인지',
        situation: '"야구 방망이와 공의 가격은 합쳐서 1,100원이다. 방망이는 공보다 1,000원 비싸다."',
        question: '공의 가격은?',
        choices: [
          { text: '100원', percent: 58, type: '직관적 사고형', typeDesc: '빠른 판단을 선호하는 시스템1 우세 성향입니다.', philosopher: '대니얼 카너먼', philoEmoji: '💨', philoQuote: '"빠른 생각, 느린 생각"', book: 'psychology' },
          { text: '50원', percent: 42, type: '분석적 사고형', typeDesc: '논리적 검증을 거치는 시스템2 우세 성향입니다.', philosopher: '르네 데카르트', philoEmoji: '🔍', philoQuote: '"나는 생각한다, 고로 존재한다"', book: 'philosophy' }
        ],
        principle: '인지적 구두쇠',
        explanation: '정답은 50원이다. 하지만 58%가 100원이라고 답한다. 뇌는 깊이 생각하기를 싫어한다.',
        source: 'Frederick, 2005 (CRT)',
        bookPromo: true
      },
      {
        category: '심리 · 협력',
        situation: '당신과 동료가 함께 체포되어 각각 다른 방에서 심문을 받고 있다. 검사가 제안한다: 둘 다 묵비권을 행사하면 증거 부족으로 각각 1년형. 둘 다 자백하면 각각 5년형. 하지만 한 명만 자백하면, 자백한 사람은 석방되고 묵비권을 행사한 사람은 10년형을 받는다. 동료가 어떤 선택을 할지 알 수 없다.',
        question: '당신의 선택은?',
        choices: [
          { text: '묵비권 (협력)', percent: 37, type: '협력 추구형', typeDesc: '단기적 이익보다 상호 신뢰를 중시합니다.', philosopher: '장자크 루소', philoEmoji: '🤝', philoQuote: '"신뢰가 사회를 만든다"' },
          { text: '자백 (배신)', percent: 63, type: '전략적 이기주의자', typeDesc: '게임 규칙 안에서 최선의 전략을 택합니다.', philosopher: '니콜로 마키아벨리', philoEmoji: '🦊', philoQuote: '"목적이 수단을 정당화한다"' }
        ],
        principle: '죄수의 딜레마',
        explanation: '개인적으로 합리적인 선택(자백)이 집단적으로는 최악의 결과를 낳는다.',
        source: 'Axelrod, 1984',
        bookPromo: true
      },
      {
        category: '심리 · 정체성',
        situation: '고대 그리스의 영웅 테세우스가 타고 다니던 배가 있다. 아테네 사람들은 이 배를 기념물로 보존했다. 세월이 흐르며 나무 판자가 썩을 때마다 새 판자로 교체했다. 결국 모든 판자가 교체되었다.',
        question: '이것은 원래의 배인가?',
        choices: [
          { text: '같은 배다', percent: 56, type: '관계 중시형', typeDesc: '겉모습이 바뀌어도 관계와 역사가 정체성을 만든다고 봅니다.', philosopher: '존 로크', philoEmoji: '🔗', philoQuote: '"정체성은 기억의 연속성이다"' },
          { text: '다른 배다', percent: 44, type: '본질 중시형', typeDesc: '구성 요소가 바뀌면 더 이상 같은 것이 아니라고 봅니다.', philosopher: '헤라클레이토스', philoEmoji: '🌊', philoQuote: '"같은 강에 두 번 들어갈 수 없다"' }
        ],
        principle: '정체성의 역설',
        explanation: '인간의 세포도 7-10년마다 거의 다 교체된다. 10년 전의 "나"와 지금의 "나"는 같은가?',
        source: 'Derek Parfit의 정체성 철학'
      },
      {
        category: '심리 · 자기인식',
        situation: '심리학 연구에 따르면, 사람들은 "10년 전의 나"는 많이 변했다고 느끼지만, "10년 후의 나"는 지금과 비슷할 거라고 예측한다.',
        question: '10년 후의 당신은 지금과 얼마나 다를까?',
        choices: [
          { text: '비슷할 것이다', percent: 75, type: '현재 고정형', typeDesc: '지금의 나를 완성형으로 보는 경향이 있습니다.', philosopher: '대니얼 길버트', philoEmoji: '📍', philoQuote: '"우리는 현재를 역사의 종착점으로 착각한다"' },
          { text: '많이 다를 것이다', percent: 25, type: '변화 수용형', typeDesc: '미래의 변화 가능성을 열어두는 성향입니다.', philosopher: '헤라클레이토스', philoEmoji: '🌊', philoQuote: '"변하지 않는 것은 변화뿐이다"' }
        ],
        principle: '역사 종결 착각',
        explanation: '19,000명을 조사한 결과, 모든 연령대가 과거의 변화는 인정하면서 미래 변화는 과소평가했다. 지금의 "나"를 최종 버전으로 착각하는 것이다.',
        source: 'Quoidbach, Gilbert & Wilson, Science, 2013'
      },
      {
        category: '철학 · 자유의지',
        situation: '당신이 커피를 마시기로 "결정"하기 0.5초 전, 뇌는 이미 손을 뻗으라는 신호를 보냈다.\n\n신경과학자 리벳의 실험이다. 우리가 "내가 선택했어"라고 느끼는 순간, 뇌는 이미 결정을 끝낸 뒤였다.\n\n그렇다면 "나"는 누구인가? 결정을 내리는 주체인가, 결정을 통보받는 관찰자인가?',
        question: '자유의지는 존재하는가?',
        choices: [
          { text: '그래도 존재한다', percent: 58, type: '양립론자', typeDesc: '뇌가 먼저 반응해도 "거부권"은 남아있습니다. 충동을 느꼈지만 멈출 수 있다면, 그것이 자유의지입니다. 데닛은 자유의지를 "거부할 수 있는 능력"으로 재정의합니다.', philosopher: '대니얼 데닛', philoEmoji: '🧠', philoQuote: '"자유의지는 피해야 할 것을 피하는 능력이다"' },
          { text: '환상이다', percent: 42, type: '결정론자', typeDesc: '모든 생각, 욕구, 결정은 뇌의 신경세포가 만든 결과입니다. "내가 원해서"가 아니라 "뇌가 그렇게 작동해서"입니다. 스피노자는 자유의지를 "무지에서 오는 착각"이라 했습니다.', philosopher: '바뤼흐 스피노자', philoEmoji: '⚙️', philoQuote: '"인간은 자신이 자유롭다고 믿지만, 꿈을 꾸는 것이다"' }
        ],
        principle: '리벳 실험',
        explanation: '1983년 벤자민 리벳의 실험은 철학계를 뒤흔들었다. 피실험자가 손가락을 움직이기로 "결정했다"고 보고한 시점보다 0.5초 전에, 뇌는 이미 "준비전위"를 발생시켰다. 의식적 결정이 원인이 아니라 결과일 수 있다는 것이다. 하지만 리벳 자신은 "거부권(veto)"의 존재를 강조했다. 충동이 올라와도 멈출 수 있다면, 그것이 자유의지라고.',
        source: 'Benjamin Libet, "Time of Conscious Intention to Act", Brain, 1983'
      },
      {
        category: '철학 · 인식',
        situation: '당신이 보는 "빨강"이 내가 보는 "빨강"과 같을까?\n\n우리 둘 다 사과를 보고 "빨갛다"고 말한다. 하지만 당신 뇌 속에서 경험되는 빨강이 내 뇌 속의 빨강과 같다는 보장이 있는가?\n\n어쩌면 당신의 빨강은 내 파랑일 수도 있다. 단지 우리 모두 그것을 "빨강"이라 배웠을 뿐.',
        question: '우리는 같은 세계를 경험하고 있는가?',
        choices: [
          { text: '같은 경험이다 (뇌 구조가 같으니까)', percent: 45, type: '물리주의자', typeDesc: '같은 파장, 같은 뇌 구조라면 같은 경험일 것이다. 하지만 "경험 자체"를 비교할 방법이 없다. 당신의 의식 안으로 들어갈 수 없으니까.', philosopher: '대니얼 데닛', philoEmoji: '🧠', philoQuote: '"의식은 뇌의 작동일 뿐이다"' },
          { text: '알 수 없다 (확인 불가능)', percent: 55, type: '현상학적 회의론자', typeDesc: '주관적 경험(퀄리아)은 제3자가 접근할 수 없다. 나는 오직 내 경험만 알 수 있다. 타인의 내면은 영원히 블랙박스다.', philosopher: '토마스 네이글', philoEmoji: '🦇', philoQuote: '"박쥐가 된다는 것은 어떤 것일까?"' }
        ],
        principle: '역전 스펙트럼 / 퀄리아',
        explanation: '철학에서 가장 풀리지 않는 문제 중 하나. 당신과 내가 "같은" 빨강을 본다고 확신할 방법이 없다. 더 나아가: 다른 사람에게 의식이 있다는 것조차 증명할 수 없다. 모두가 좀비(행동만 하고 내면 경험이 없는 존재)일 수도 있다.',
        source: 'John Locke, 1690 / Thomas Nagel, "What Is It Like to Be a Bat?", 1974'
      },
      {
        category: '철학 · 정의',
        situation: '당신은 태어나기 전이다.\n\n사회의 모든 규칙을 정할 수 있다. 하지만 한 가지 조건: 당신이 그 사회에서 어떤 위치로 태어날지 모른다.\n\n부자일 수도, 빈자일 수도, 장애인일 수도, 천재일 수도 있다.\n\n당신은 어떤 규칙을 세우겠는가?',
        question: '불평등을 허용하겠는가?',
        choices: [
          { text: '완전한 평등 (모두 같게)', percent: 35, type: '평등주의자', typeDesc: '누가 될지 모르니 모두를 같게. 하지만 롤스도 완전한 평등은 주장하지 않았습니다. 왜일까요?', philosopher: '장 자크 루소', philoEmoji: '⚖️', philoQuote: '"인간은 자유롭게 태어났으나 어디서나 사슬에 묶여 있다"' },
          { text: '불평등 허용 (단, 최하층에 이득이 되는 경우만)', percent: 65, type: '차등 원칙 지지자', typeDesc: '롤스의 답: 불평등은 허용되지만, 오직 그것이 가장 불리한 사람에게 이익이 될 때만. 이것이 "정의"입니다.', philosopher: '존 롤스', philoEmoji: '🎭', philoQuote: '"무지의 베일 뒤에서 선택하라"' }
        ],
        principle: '무지의 베일',
        explanation: '롤스의 사고 실험. 자신이 누구인지 모르는 상태에서 사회를 설계하면 어떻게 될까? 대부분 "최악의 경우"를 대비한다. 이것이 공정한 사회의 원칙이다. 당신의 기득권을 빼면, 당신은 어떤 세상을 원하는가?',
        source: 'John Rawls, "A Theory of Justice", 1971'
      },
      {
        category: '심리 · 선택',
        situation: '잼 시식 코너. A 매장: 24종류 / B 매장: 6종류',
        question: '어디서 더 많이 구매할까?',
        choices: [
          { text: 'A (선택지가 많은 곳)', percent: 34, type: '다양성 선호형', typeDesc: '많은 선택지를 좋아하는 성향입니다.', philosopher: '존 스튜어트 밀', philoEmoji: '🌈', philoQuote: '"자유론"' },
          { text: 'B (선택지가 적은 곳)', percent: 66, type: '선택 과부하 인식형', typeDesc: '과도한 선택지가 마비를 유발함을 압니다.', philosopher: '배리 슈워츠', philoEmoji: '🎯', philoQuote: '"선택의 역설"' }
        ],
        principle: '선택 과부하',
        explanation: '24종류에서는 3%만, 6종류에서는 30%가 구매했다. 선택지가 많으면 선택을 포기한다.',
        source: 'Iyengar & Lepper, 2000'
      }
    ];

    let selectedChoice = null;
    let dailyData = { lastDate: null, streak: 0, history: {} };

    function loadDailyData() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) dailyData = JSON.parse(saved);
    }

    function saveDailyData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(dailyData));
    }

    function getTodayString() {
      const t = new Date();
      return t.getFullYear() + '-' + String(t.getMonth()+1).padStart(2,'0') + '-' + String(t.getDate()).padStart(2,'0');
    }

    function getDayOfYear() {
      const now = new Date();
      const start = new Date(now.getFullYear(), 0, 0);
      return Math.floor((now - start) / 86400000);
    }

    function getTodayDilemma() {
      return dilemmas[getDayOfYear() % dilemmas.length];
    }

    function formatDate() {
      const t = new Date();
      const days = ['일','월','화','수','목','금','토'];
      return (t.getMonth()+1) + '월 ' + t.getDate() + '일 (' + days[t.getDay()] + ')';
    }

    function formatDateShort() {
      const t = new Date();
      return t.getFullYear() + '.' + String(t.getMonth()+1).padStart(2,'0') + '.' + String(t.getDate()).padStart(2,'0');
    }

    function updateStreak() {
      const today = getTodayString();
      const y = new Date(); y.setDate(y.getDate() - 1);
      const yesterday = y.getFullYear() + '-' + String(y.getMonth()+1).padStart(2,'0') + '-' + String(y.getDate()).padStart(2,'0');
      if (dailyData.lastDate !== today && dailyData.lastDate !== yesterday) {
        dailyData.streak = 0;
        saveDailyData();
      }
    }

    function getTimeUntilMidnight() {
      const now = new Date();
      const mid = new Date(now); mid.setHours(24,0,0,0);
      return mid - now;
    }

    function formatTime(ms) {
      const h = Math.floor(ms/3600000);
      const m = Math.floor((ms%3600000)/60000);
      const s = Math.floor((ms%60000)/1000);
      return String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
    }

    function startTimer() {
      setInterval(() => {
        document.getElementById('timerDisplay').textContent = formatTime(getTimeUntilMidnight());
      }, 1000);
    }

    function init() {
      loadDailyData();
      updateStreak();
      document.getElementById('dateDisplay').textContent = formatDate();
      
      const streakCard = document.getElementById('streakCard');
      if (dailyData.streak > 0) {
        document.getElementById('streakNum').textContent = dailyData.streak;
        streakCard.style.display = 'flex';
      }
      
      const today = getTodayString();
      if (dailyData.history[today] !== undefined) {
        showAlreadyDone(dailyData.history[today]);
        return;
      }
      
      renderDilemma(getTodayDilemma());
    }

    function showAlreadyDone(idx) {
      const dilemma = getTodayDilemma();
      const choice = dilemma.choices[idx];
      const otherIdx = idx === 0 ? 1 : 0;
      const otherChoice = dilemma.choices[otherIdx];
      
      document.getElementById('mainContent').classList.add('hidden');
      document.getElementById('alreadyDone').classList.remove('hidden');
      
      // 딜레마 내용 채우기
      document.getElementById('dilemmaCategoryDone').textContent = dilemma.category;
      document.getElementById('dilemmaSituationDone').textContent = dilemma.situation;
      document.getElementById('dilemmaQuestionDone').textContent = dilemma.question;
      
      // 내 선택 표시
      document.getElementById('myChoiceTextDone').textContent = choice.text;
      
      // 성향 카드 데이터 채우기
      document.getElementById('cardBadgeDone').textContent = dilemma.category;
      document.getElementById('cardPercentDone').textContent = choice.percent;
      document.getElementById('cardTypeNameDone').textContent = choice.type;
      document.getElementById('cardTypeDescDone').textContent = choice.typeDesc;
      document.getElementById('cardPhiloEmojiDone').textContent = choice.philoEmoji;
      document.getElementById('cardPhiloNameDone').textContent = choice.philosopher;
      document.getElementById('cardPhiloDescDone').textContent = choice.philoQuote;
      document.getElementById('cardDateDone').textContent = formatDateShort();
      
      // 다른 선택지 해설 채우기
      document.getElementById('otherChoiceTextDone').textContent = otherChoice.text;
      document.getElementById('otherPercentDone').textContent = otherChoice.percent + '%가 선택';
      document.getElementById('otherTypeDone').textContent = otherChoice.type;
      document.getElementById('otherTypeDescDone').textContent = otherChoice.typeDesc;
      document.getElementById('otherPhiloEmojiDone').textContent = otherChoice.philoEmoji;
      document.getElementById('otherPhiloNameDone').textContent = otherChoice.philosopher;
      document.getElementById('otherPhiloQuoteDone').textContent = otherChoice.philoQuote;
      
      // 연구 결과 해설 채우기
      document.getElementById('resultTitleDone').textContent = dilemma.principle;
      document.getElementById('resultDescDone').textContent = dilemma.explanation;
      document.getElementById('resultSourceDone').textContent = '출처: ' + dilemma.source;
      
      // 책 프로모션 (bookPromo가 있는 딜레마만)
      if (dilemma.bookPromo) {
        document.getElementById('bookPromoDone').classList.remove('hidden');
      }
      
      // 아코디언 토글
      const toggleBtn = document.getElementById('otherChoiceToggle');
      const toggleContent = document.getElementById('otherChoiceContent');
      const toggleArrow = document.getElementById('toggleArrow');
      
      toggleBtn.addEventListener('click', () => {
        toggleContent.classList.toggle('hidden');
        toggleArrow.textContent = toggleContent.classList.contains('hidden') ? '▼' : '▲';
      });
      
      // 버튼 이벤트
      document.getElementById('saveImageBtnDone').addEventListener('click', () => saveImageDone(idx));
      document.getElementById('shareBtnDone').addEventListener('click', () => shareResultDone(idx));
      
      startTimer();
    }
    
    function saveImageDone(idx) {
      const card = document.getElementById('profileCardDone');
      const btn = document.getElementById('saveImageBtnDone');
      btn.innerHTML = '저장 중...';
      
      html2canvas(card, { backgroundColor: '#09090b', scale: 2 }).then(canvas => {
        const link = document.createElement('a');
        link.download = 'dilem-' + formatDateShort() + '.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
        
        btn.classList.add('success');
        btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> 저장 완료!';
        setTimeout(() => {
          btn.classList.remove('success');
          btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> 이미지 저장';
        }, 2000);
      });
    }
    
    function shareResultDone(idx) {
      const d = getTodayDilemma();
      const c = d.choices[idx];
      const text = '🤔 오늘의 딜레마\n\n"' + d.question + '"\n\n나의 선택 → ' + c.type + '\n(' + c.percent + '%가 같은 선택)\n\n비슷한 철학자: ' + c.philosopher + '\n' + c.philoQuote + '\n\n당신의 선택은?';
      
      if (navigator.share) {
        navigator.share({ title: '오늘의 딜레마', text: text, url: 'https://eclipse-mindlab.github.io/mindlab/daily.html' }).catch(() => {});
      } else {
        navigator.clipboard.writeText(text + '\nhttps://eclipse-mindlab.github.io/mindlab/daily.html').then(() => {
          const btn = document.getElementById('shareBtnDone');
          btn.classList.add('success');
          btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> 복사됨!';
          setTimeout(() => {
            btn.classList.remove('success');
            btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg> 공유하기';
          }, 2000);
        });
      }
    }

    function renderDilemma(d) {
      document.getElementById('dilemmaCategory').textContent = d.category;
      document.getElementById('dilemmaSituation').textContent = d.situation;
      document.getElementById('dilemmaQuestion').textContent = d.question;
      
      const el = document.getElementById('choices');
      el.innerHTML = d.choices.map((c, i) => 
        '<button class="choice-btn" data-index="'+i+'"><div class="choice-content"><span class="choice-text">'+c.text+'</span><div class="choice-stats"><span class="stat-percent">'+c.percent+'%</span><div class="stat-bar"><div class="stat-fill" style="width:0%"></div></div></div></div></button>'
      ).join('');
      
      el.querySelectorAll('.choice-btn').forEach(btn => {
        btn.addEventListener('click', () => handleChoice(parseInt(btn.dataset.index)));
      });
    }

    function handleChoice(index) {
      if (selectedChoice !== null) return;
      const today = getTodayString();
      if (dailyData.history[today] !== undefined) return;
      
      selectedChoice = index;
      const dilemma = getTodayDilemma();
      
      const y = new Date(); y.setDate(y.getDate() - 1);
      const yesterday = y.getFullYear() + '-' + String(y.getMonth()+1).padStart(2,'0') + '-' + String(y.getDate()).padStart(2,'0');
      
      if (dailyData.lastDate === yesterday) dailyData.streak += 1;
      else if (dailyData.lastDate !== today) dailyData.streak = 1;
      
      dailyData.history[today] = index;
      dailyData.lastDate = today;
      saveDailyData();
      
      // 프로필 처리 - 없으면 익명으로 생성
      let ps = localStorage.getItem(PROFILE_KEY);
      let p;
      if (ps) {
        p = JSON.parse(ps);
      } else {
        p = { name: '익명 탐험가', level: 1, exp: 0, cleared: [], principles: [] };
      }
      p.exp = (p.exp || 0) + 10;
      const need = (p.level || 1) * 100;
      while (p.exp >= need) { p.exp -= need; p.level = (p.level || 1) + 1; }
      localStorage.setItem(PROFILE_KEY, JSON.stringify(p));
      saveProfileToCloud(p); // Firebase 저장
      
      document.getElementById('streakNum').textContent = dailyData.streak;
      document.getElementById('streakCard').style.display = 'flex';
      
      document.querySelectorAll('.choice-btn').forEach((btn, i) => {
        btn.classList.add('revealed');
        if (i === index) btn.classList.add('selected');
        btn.querySelector('.choice-stats').classList.add('show');
        setTimeout(() => {
          btn.querySelector('.stat-fill').style.width = dilemma.choices[i].percent + '%';
        }, 100);
      });
      
      const c = dilemma.choices[index];
      const otherIdx = index === 0 ? 1 : 0;
      const otherChoice = dilemma.choices[otherIdx];
      
      document.getElementById('cardBadge').textContent = dilemma.category;
      document.getElementById('cardPercent').textContent = c.percent;
      document.getElementById('cardTypeName').textContent = c.type;
      document.getElementById('cardTypeDesc').textContent = c.typeDesc;
      document.getElementById('cardPhiloEmoji').textContent = c.philoEmoji;
      document.getElementById('cardPhiloName').textContent = c.philosopher;
      document.getElementById('cardPhiloDesc').textContent = c.philoQuote;
      document.getElementById('cardDate').textContent = formatDateShort();
      
      // 다른 선택지 해설 채우기
      document.getElementById('otherChoiceTextFirst').textContent = otherChoice.text;
      document.getElementById('otherPercentFirst').textContent = otherChoice.percent + '%가 선택';
      document.getElementById('otherTypeFirst').textContent = otherChoice.type;
      document.getElementById('otherTypeDescFirst').textContent = otherChoice.typeDesc;
      document.getElementById('otherPhiloEmojiFirst').textContent = otherChoice.philoEmoji;
      document.getElementById('otherPhiloNameFirst').textContent = otherChoice.philosopher;
      document.getElementById('otherPhiloQuoteFirst').textContent = otherChoice.philoQuote;
      
      // 아코디언 토글
      const toggleBtnFirst = document.getElementById('otherChoiceToggleFirst');
      const toggleContentFirst = document.getElementById('otherChoiceContentFirst');
      const toggleArrowFirst = document.getElementById('toggleArrowFirst');
      
      toggleBtnFirst.addEventListener('click', () => {
        toggleContentFirst.classList.toggle('hidden');
        toggleArrowFirst.textContent = toggleContentFirst.classList.contains('hidden') ? '▼' : '▲';
      });
      
      document.getElementById('resultTitle').textContent = dilemma.principle;
      document.getElementById('resultDesc').textContent = dilemma.explanation;
      document.getElementById('resultSource').textContent = '📚 ' + dilemma.source;
      
      // 책 프로모션 (bookPromo가 있는 딜레마만)
      if (dilemma.bookPromo) {
        document.getElementById('bookPromoFirst').classList.remove('hidden');
      }
      
      setTimeout(() => {
        document.getElementById('resultSection').classList.add('show');
        document.getElementById('saveImageBtn').addEventListener('click', saveImage);
        document.getElementById('shareBtn').addEventListener('click', shareResult);
      }, 600);
    }

    function saveImage() {
      const card = document.getElementById('profileCard');
      const btn = document.getElementById('saveImageBtn');
      btn.innerHTML = '저장 중...';
      
      html2canvas(card, { backgroundColor: '#09090b', scale: 2 }).then(canvas => {
        const link = document.createElement('a');
        link.download = 'dilem-' + formatDateShort() + '.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
        
        btn.classList.add('success');
        btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> 저장 완료!';
        setTimeout(() => {
          btn.classList.remove('success');
          btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> 이미지 저장';
        }, 2000);
      });
    }

    function shareResult() {
      const d = getTodayDilemma();
      const c = d.choices[selectedChoice];
      const text = '🤔 오늘의 딜레마\n\n"' + d.question + '"\n\n나의 선택 → ' + c.type + '\n(' + c.percent + '%가 같은 선택)\n\n비슷한 철학자: ' + c.philosopher + '\n' + c.philoQuote + '\n\n당신의 선택은?';
      
      if (navigator.share) {
        navigator.share({ title: '오늘의 딜레마', text: text, url: 'https://eclipse-mindlab.github.io/mindlab/daily.html' }).catch(() => {});
      } else {
        navigator.clipboard.writeText(text + '\nhttps://eclipse-mindlab.github.io/mindlab/daily.html').then(() => {
          const btn = document.getElementById('shareBtn');
          btn.classList.add('success');
          btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> 복사됨!';
          setTimeout(() => {
            btn.classList.remove('success');
            btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg> 공유하기';
          }, 2000);
        });
      }
    }

    init();
  </script>
</body>
</html>
